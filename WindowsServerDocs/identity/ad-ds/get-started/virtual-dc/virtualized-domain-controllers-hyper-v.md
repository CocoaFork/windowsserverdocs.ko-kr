---
title: Hyper-v를 사용 하 여 도메인 컨트롤러 가상화
description: Hyper-v에서 Windows Server Active Directory 도메인 컨트롤러를 가상화 할 때 수행할 고려 사항
author: MicrosoftGuyJFlo
ms.author: joflore
ms.date: 04/19/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.openlocfilehash: 491f4f2e2526e7cff024779ee3ecf9f771e64af4
ms.sourcegitcommit: 23a6e83b688119c9357262b6815c9402c2965472
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 08/16/2019
ms.locfileid: "69560573"
---
# <a name="virtualizing-domain-controllers-using-hyper-v"></a>Hyper-v를 사용 하 여 도메인 컨트롤러 가상화

> 적용 대상: Windows Server 2016

이 항목은 Windows Server 2016에 적용 되는 지침을 수행 하기 위해 업데이트 됩니다. Windows Server 2012에는 가상 dc에서 USN 롤백이 발생 하지 않도록 방지 하는 보호 기능을 비롯 하 여 가상화 된 Dc (도메인 컨트롤러)에 대 한 다양 한 개선 사항이 도입 되었습니다. 이러한 개선 사항에 대 한 자세한 내용은 [Active Directory Domain Services (AD DS) 가상화 소개 (수준 100)](../../introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100.md)를 참조 하세요.

Hyper-v는 여러 서버 역할을 단일 물리적 컴퓨터로 통합 합니다. 이 가이드에서는 도메인 컨트롤러를 32 비트 또는 64 비트 게스트 운영 체제로 실행 하는 방법을 설명 합니다.

## <a name="planning-to-virtualize-domain-controllers"></a>도메인 컨트롤러 가상화 계획

이 섹션에서는 Hyper-v 서버에 대 한 하드웨어 요구 사항, 단일 실패 지점이 발생 하지 않도록 하는 방법, Hyper-v 서버 및 가상 컴퓨터에 적절 한 구성 유형 선택, 보안 및 성능 결정을 설명 합니다.

## <a name="hyper-v-requirements"></a>Hyper-v 요구 사항

Hyper-v 역할을 설치 하 고 사용 하려면 다음이 필요 합니다.

   - **X64 프로세서**
      - Hyper-v는 Windows Server 2008 이상 버전의 x64 기반 버전에서 사용할 수 있습니다.  
   - **하드웨어 지원 가상화**
      - 이 기능은 가상화 옵션, 특히 intel VT (intel 가상화 기술) 또는 amd 가상화 (AMD)를 포함 하는 프로세서에서 사용할 수 있습니다.  
   - **하드웨어 DEP (데이터 실행 보호)**
      - 하드웨어 DEP를 사용 가능 하 고 사용 하도록 설정 해야 합니다. 특히 Intel XD 비트 (execute disable bit) 또는 AMD NX 비트 (실행 비트 없음)를 사용 하도록 설정 해야 합니다.  

## <a name="avoid-creating-single-points-of-failure"></a>단일 실패 지점이 생성 되지 않도록 방지

가상 도메인 컨트롤러 배포를 계획할 때 잠재적인 단일 실패 지점이 생성 되는 것을 방지 해야 합니다. 시스템 중복성을 구현 하 여 잠재적인 단일 실패 지점이 발생 하지 않도록 할 수 있습니다. 예를 들어 다음 권장 사항을 고려 하 여 관리 비용이 늘어날 가능성을 염두에 두어야 합니다.

1. 여러 가상화 호스트에서 도메인당 가상화 된 도메인 컨트롤러를 두 개 이상 실행 하면 단일 가상화 호스트에 오류가 발생 하는 경우 모든 도메인 컨트롤러가 손실 될 위험이 줄어듭니다.  
2. 다른 기술에 대 한 권장 사항에 따라 도메인 컨트롤러를 실행 하는 데 사용 되는 다른 Cpu, 마더보드, 네트워크 어댑터 또는 기타 하드웨어를 사용 하 여 하드웨어를 다양화. 하드웨어 diversification 공급 업체 구성, 드라이버 또는 단일 부분 또는 하드웨어와 관련 된 오작동으로 인해 발생할 수 있는 손상을 제한 합니다.  
3. 가능 하면 도메인 컨트롤러가 전 세계의 다른 지역에 있는 하드웨어에서 실행 되어야 합니다. 이를 통해 도메인 컨트롤러를 호스트 하는 사이트에 영향을 주는 재해 또는 실패의 영향을 줄일 수 있습니다.  
4. 각 도메인에서 실제 도메인 컨트롤러를 유지 관리 합니다. 이는 해당 플랫폼을 사용 하는 모든 호스트 시스템에 영향을 주는 가상화 플랫폼 오작동의 위험을 완화 합니다.  

## <a name="security-considerations"></a>보안 고려 사항

가상 도메인 컨트롤러를 실행 하는 호스트 컴퓨터는 도메인에 가입 된 도메인 또는 작업 그룹 컴퓨터인 경우에도 쓰기 가능한 도메인 컨트롤러를 신중 하 게 관리 해야 합니다. 이는 중요 한 보안 고려 사항입니다. 잘못 관리 된 호스트는 권한 상승 공격에 취약 합니다 .이 문제는 악의적인 사용자가 권한이 부여 되지 않았거나 합법적으로 할당 되지 않은 액세스 및 시스템 권한을 얻을 때 발생 합니다. 악의적인 사용자는이 유형의 공격을 사용 하 여이 컴퓨터에서 호스팅하는 모든 가상 컴퓨터, 도메인 및 포리스트를 손상 시킬 수 있습니다.

도메인 컨트롤러를 가상화 할 계획인 경우 다음 보안 고려 사항을 염두에 두어야 합니다.

   - 가상의 쓰기 가능한 도메인 컨트롤러를 호스트 하는 컴퓨터의 로컬 관리자는 해당 도메인 컨트롤러가 속한 모든 도메인 및 포리스트의 기본 도메인 관리자에 대 한 자격 증명에 해당 하는 것으로 간주 되어야 합니다.  
   - 보안 및 성능 문제를 방지 하기 위한 권장 구성은 Hyper-v 이외의 다른 응용 프로그램이 없는 Windows Server 2008 이상 버전의 Server Core 설치를 실행 하는 호스트입니다. 이 구성은 서버에 설치 된 응용 프로그램 및 서비스의 수를 제한 하 여 컴퓨터 또는 네트워크를 공격 하는 데 악의적으로 악용 될 수 있는 응용 프로그램 및 서비스와 성능 향상을 초래 합니다. 이러한 유형의 구성으로 인해 공격 노출 영역이 감소 하는 것으로 알려져 있습니다. 안전 하 게 보호할 수 없는 지점 또는 다른 위치에서는 RODC (읽기 전용 도메인 컨트롤러)를 권장 합니다. 별도의 관리 네트워크가 있는 경우 호스트를 관리 네트워크에만 연결 하는 것이 좋습니다.  
   - 도메인 컨트롤러와 함께 Bitlocker를 사용할 수 있습니다. Windows Server 2016에서는 가상 TPM 기능을 사용 하 여 시스템 볼륨의 잠금을 해제 하는 게스트 키 자료를 제공할 수도 있습니다.
   - 보호 된 [패브릭 및 차폐 vm](/it-server/WindowsServerDocs/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms.md) 은 도메인 컨트롤러를 보호 하기 위한 추가 제어를 제공할 수 있습니다.

Rodc에 대 한 자세한 내용은 [읽기 전용 도메인 컨트롤러 계획 및 배포 가이드](../../deploy/rodc/read-only-domain-controller-updates.md)를 참조 하세요.

도메인 컨트롤러를 보호 하는 방법에 대 한 자세한 내용은 [모범 사례 가이드에서 Active Directory 설치 보안 유지](../../plan/security-best-practices/best-practices-for-securing-active-directory.md)를 참조 하세요.

## <a name="security-boundaries-for-different-host-and-guest-configurations"></a>여러 호스트 및 게스트 구성의 보안 경계

Virtual machines를 사용 하면 다양 한 도메인 컨트롤러 구성을 사용할 수 있습니다. 가상 컴퓨터가 Active Directory 토폴로지의 경계 및 트러스트에 영향을 주는 방법에 대해 신중 하 게 고려해 야 합니다. Active Directory 도메인 컨트롤러 및 호스트 (hyper-v 서버)와 게스트 컴퓨터 (Hyper-v 서버에서 실행 되는 가상 컴퓨터)에 대 한 가능한 구성은 다음 표에 설명 되어 있습니다.

|Machine|구성 1|Configuration 2|
|-------|---------------|---------------|
|Host|작업 그룹 또는 구성원 컴퓨터|작업 그룹 또는 구성원 컴퓨터|
|게스트|도메인 컨트롤러|작업 그룹 또는 구성원 컴퓨터|

![](media/virtualized-domain-controller-architecture/Dd363553.f44706fd-317e-4f0b-9578-4243f4db225f(WS.10).gif)

   - 호스트 컴퓨터의 관리자는 쓰기 가능한 도메인 컨트롤러 게스트에 대 한 도메인 관리자와 동일한 액세스 권한을 가지 며 이와 같이 처리 해야 합니다. RODC 게스트의 경우 호스트 컴퓨터의 관리자는 게스트 RODC의 로컬 관리자와 동일한 액세스 권한을 가집니다.   
   - 호스트가 동일한 도메인에 가입 되어 있는 경우 가상 컴퓨터의 도메인 컨트롤러에는 호스트에 대 한 관리 권한이 있습니다. 악의적인 사용자가 가상 컴퓨터 1에 처음으로 액세스 하는 경우 악의적인 사용자가 모든 가상 컴퓨터를 손상 시킬 수 있는 기회가 있습니다. 이를 공격 벡터 라고 합니다. 여러 도메인 또는 포리스트에 대 한 도메인 컨트롤러가 있는 경우 이러한 도메인은 한 도메인의 관리자가 모든 도메인에서 트러스트 되는 중앙 집중식 관리를가지고 있어야 합니다.  
   - 가상 컴퓨터 1의 공격에 대 한 기회는 가상 컴퓨터 1이 RODC로 설치 된 경우에도 존재 합니다. RODC의 관리자에 게는 명시적으로 도메인 관리자 권한이 없지만 RODC를 사용 하 여 호스트 컴퓨터에 정책을 보낼 수 있습니다. 이러한 정책에는 시작 스크립트가 포함 될 수 있습니다. 이 작업이 성공적으로 수행 되 면 호스트 컴퓨터가 손상 될 수 있으며 호스트 컴퓨터의 다른 가상 컴퓨터를 손상 시키는 데 사용할 수 있습니다.  

## <a name="security-of-vhd-files"></a>VHD 파일의 보안

가상 도메인 컨트롤러의 VHD 파일은 실제 도메인 컨트롤러의 실제 하드 드라이브와 동일 합니다. 따라서 실제 도메인 컨트롤러의 하드 드라이브를 보호 하는 것과 동일한 수준의 주의를 기울여야 합니다. 신뢰할 수 있고 신뢰할 수 있는 관리자만 도메인 컨트롤러의 VHD 파일에 대 한 액세스를 허용 하는지 확인 합니다.

## <a name="rodcs"></a>Rodc

Rodc의 장점 중 하나는 지점과 같이 물리적 보안을 보장할 수 없는 위치에이를 배치할 수 있는 기능입니다. Windows BitLocker 드라이브 암호화를 사용 하 여 실제 디스크의 도난 으로부터 호스트의 손상 으로부터 VHD 파일 자체 (파일 시스템이 아닌)를 보호할 수 있습니다. 

## <a name="performance"></a>성능

새 마이크로 커널 64 비트 아키텍처를 사용 하는 경우 이전 가상화 플랫폼에서 Hyper-v 성능이 크게 향상 되었습니다. 호스트의 성능을 최적화 하려면 호스트는 Windows Server 2008 이상의 Server Core 설치 여야 하며 Hyper-v가 설치 된 서버 역할을 포함 하지 않아야 합니다.

가상 컴퓨터의 성능은 워크 로드에 따라 달라 집니다. 적절 한 Active Directory 성능을 보장 하려면 특정 토폴로지를 테스트 합니다. 안정성 및 성능 모니터 (Perfmon.exe) 또는 [Microsoft 평가 및 계획 (MAP) 도구 키트](https://go.microsoft.com/fwlink/?linkid=137077)와 같은 도구를 사용 하 여 일정 기간 동안 현재 워크 로드를 평가 합니다. 네트워크에 현재 존재 하는 모든 서버 및 서버 역할의 인벤토리를 사용 하려는 경우에도 지도 도구가 유용할 수 있습니다.

가상화 된 도메인 컨트롤러의 성능에 대 한 일반적인 아이디어를 얻기 위해 다음 성능 테스트는 [Active Directory 성능 테스트 도구 (ADTest)](https://go.microsoft.com/fwlink/?linkid=137088)를 사용 하 여 수행 되었습니다.

LDAP (Lightweight Directory Access Protocol) 테스트가 ADTest를 사용 하는 실제 도메인 컨트롤러에서 실행 된 후 실제 도메인 컨트롤러와 동일한 서버에서 호스팅되는 가상 컴퓨터에 실행 되었습니다. 물리적 컴퓨터에는 하나의 논리 프로세서만 사용 되었으며 가상 머신이 100%의 CPU 사용률에 쉽게 도달할 수 있도록 가상 프로세서를 하나만 사용 했습니다. 다음 표에서 각 테스트 이후의 괄호 안에 있는 문자와 숫자는 ADTest의 특정 테스트를 의미 합니다. 이 데이터에서 볼 수 있듯이 가상화 된 도메인 컨트롤러 성능은 실제 도메인 컨트롤러 성능의 88 ~ 98% 였습니다.

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>측정</th>
<th>테스트</th>
<th>물리적</th>
<th>Virtual</th>
<th>삼각</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>검색/초</p></td>
<td><p>기본 범위에서 일반 이름 검색 (L1)</p></td>
<td><p>11508</p></td>
<td><p>10276</p></td>
<td><p>-10.71%</p></td>
</tr>
<tr class="even">
<td><p>검색/초</p></td>
<td><p>기본 범위 (L2)에서 특성 집합을 검색 합니다.</p></td>
<td><p>10123</p></td>
<td><p>9005</p></td>
<td><p>-11.04%</p></td>
</tr>
<tr class="odd">
<td><p>검색/초</p></td>
<td><p>기본 범위 (L3)의 모든 특성 검색</p></td>
<td><p>1284</p></td>
<td><p>1242</p></td>
<td><p>-3.27%</p></td>
</tr>
<tr class="even">
<td><p>검색/초</p></td>
<td><p>하위 트리 범위에서 일반 이름 검색 (L6)</p></td>
<td><p>8613</p></td>
<td><p>7904</p></td>
<td><p>-8.23%</p></td>
</tr>
<tr class="odd">
<td><p>성공한 바인딩/초</p></td>
<td><p>빠른 바인딩 수행 (B1)</p></td>
<td><p>1438</p></td>
<td><p>1374</p></td>
<td><p>-4.45%</p></td>
</tr>
<tr class="even">
<td><p>성공한 바인딩/초</p></td>
<td><p>단순 바인딩 수행 (B2)</p></td>
<td><p>611</p></td>
<td><p>550</p></td>
<td><p>-9.98%</p></td>
</tr>
<tr class="odd">
<td><p>성공한 바인딩/초</p></td>
<td><p>NTLM을 사용 하 여 바인드 수행 (B5)</p></td>
<td><p>1068</p></td>
<td><p>1056</p></td>
<td><p>-1.12%</p></td>
</tr>
<tr class="even">
<td><p>쓰기/초</p></td>
<td><p>여러 특성 쓰기 (W2)</p></td>
<td><p>6467</p></td>
<td><p>5885</p></td>
<td><p>-9.00%</p></td>
</tr>
</tbody>
</table>

적절 한 성능을 보장 하기 위해 통합 구성 요소 (IC)가 설치 되어 게스트 운영 체제에서 "enlightenments" 또는 하이퍼바이저 인식 가상 드라이버를 사용할 수 있습니다. 설치 과정에서 에뮬레이트된 IDE (Integrated Drive 가전) 또는 네트워크 어댑터 드라이버를 사용 해야 할 수도 있습니다. 프로덕션 환경에서는 이러한 에뮬레이트된 드라이버를 가상 드라이버로 바꿔 성능을 향상 시킬 수 있습니다.

가상 컴퓨터 내에서 안정성 및 성능 관리자 (Perfmon.exe)를 사용 하 여 가상 컴퓨터의 성능을 모니터링 하는 경우 실제 프로세서에서 가상 CPU가 예약 된 방법의 결과로 CPU 정보가 완전히 정확 하지는 않습니다. Hyper-v 서버에서 실행 중인 가상 컴퓨터에 대 한 CPU 정보를 가져오려면 호스트 파티션에서 Hyper-v 하이퍼바이저 논리 프로세서 카운터를 사용 합니다.

AD DS 및 Hyper-v의 성능 튜닝에 대 한 자세한 내용은 [Windows Server 2016에 대 한 성능 조정 지침](../../../../administration/performance-tuning/index.md)을 참조 하세요.

또한 차이점 보관용 디스크 VHD를 사용 하면 성능이 저하 될 수 있으므로 도메인 컨트롤러로 구성 된 가상 머신에서 차이점 보관용 디스크 VHD를 사용 하지 마십시오. 차이점 보관용 디스크를 포함 하 여 Hyper-v 디스크 유형에 대 한 자세한 내용은 [새 가상 하드 디스크 마법사](http://go.microsoft.com/fwlink/?linkid=137279)를 참조 하십시오.

가상 호스팅 환경에서의 AD DS에 대 한 자세한 내용은 Microsoft 기술 자료의 [가상 호스팅 환경에서 Active Directory 도메인 컨트롤러를 호스팅할 때 고려해 야 할 사항](https://go.microsoft.com/fwlink/?linkid=141292) 을 참조 하십시오.

## <a name="deployment-considerations-for-virtualized-domain-controllers"></a>가상화 된 도메인 컨트롤러에 대 한 배포 고려 사항

도메인 컨트롤러를 배포할 때 고려해 야 하는 몇 가지 일반적인 가상 머신 방법과 시간 동기화 및 저장소에 대 한 특별 한 고려 사항이 있습니다.

## <a name="virtualization-deployment-practices-to-avoid"></a>피할 수 있는 가상화 배포 방법

Hyper-v와 같은 가상화 플랫폼은 컴퓨터를 쉽게 관리, 유지 관리, 백업 및 마이그레이션할 수 있는 다양 한 편리한 기능을 제공 합니다. 그러나 가상 도메인 컨트롤러에는 다음과 같은 일반적인 배포 방법 및 기능을 사용 하면 안 됩니다.

- Active Directory 쓰기의 내구성을 보장 하려면 가상 도메인 컨트롤러의 데이터베이스 파일 (Active Directory 데이터베이스 (NTDS)를 배포 하지 마십시오. 가상 IDE 디스크에 대해 DIT), 로그 및 SYSVOL을 설정 합니다. 대신, 가상 SCSI 컨트롤러에 연결 된 두 번째 VHD를 만들고 도메인 컨트롤러를 설치 하는 동안 데이터베이스, 로그 및 SYSVOL을 가상 컴퓨터의 SCSI 디스크에 배치 해야 합니다.  
- 도메인 컨트롤러로 구성 하는 가상 컴퓨터에 차이점 보관용 디스크 Vhd (가상 하드 디스크)를 구현 하지 마십시오. 이렇게 하면 이전 버전으로 쉽게 되돌릴 수 없으며 성능도 저하 됩니다. VHD 유형에 대 한 자세한 내용은 [새 가상 하드 디스크 마법사](https://go.microsoft.com/fwlink/?linkid=137279)를 참조 하세요.  
- 시스템 준비 도구 (Sysprep)를 사용 하 여 처음으로 준비 되지 않은 Windows Server 운영 체제의 복사본에 새 Active Directory 도메인 및 포리스트를 배포 하지 마십시오. Sysprep을 실행 하는 방법에 대 한 자세한 내용은 [sysprep (시스템 준비) 개요](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview) 를 참조 하세요.

   > [!WARNING]
   > 도메인 컨트롤러에서 Sysprep을 실행 하는 것은 지원 되지 않습니다.

- 잠재적 USN (업데이트 시퀀스 번호) 롤백 상황을 방지 하기 위해 이미 배포 된 도메인 컨트롤러를 나타내는 VHD 파일의 복사본을 사용 하 여 추가 도메인 컨트롤러를 배포 하지 마십시오. USN 롤백에 대한 자세한 내용은 [USN 및 USN 롤백](#usn-and-usn-rollback)을 참조하세요.
   - Windows Server 2012 이상 버전에서는 추가 도메인 컨트롤러를 배포 하려는 경우 관리자가 도메인 컨트롤러 이미지를 복제할 수 있습니다.
- 도메인 컨트롤러를 실행 하는 가상 컴퓨터를 내보내는 데 Hyper-v 내보내기 기능을 사용 하지 마세요.
  - Windows Server 2012 이상에서 도메인 컨트롤러 가상 게스트의 내보내기 및 가져오기는 생성 ID의 변경을 검색 하 고 복제에 대해 구성 되지 않으므로 신뢰할 수 없는 복원과 같이 처리 됩니다.
  - 더 이상 내보낸 게스트를 사용 하 고 있지 않은지 확인 합니다.
    - Hyper-v 복제를 사용 하 여 도메인 컨트롤러의 두 번째 비활성 복사본을 유지할 수 있습니다. 복제 된 이미지를 시작 하는 경우 DC 게스트 이미지를 내보낸 후 원본을 사용 하지 않는 것과 동일한 이유로 적절 한 정리를 수행 해야 합니다.

## <a name="physical-to-virtual-migration"></a>물리적에서 가상으로 마이그레이션

System Center Virtual Machine Manager (VMM) 2008는 물리적 컴퓨터와 가상 컴퓨터의 통합 된 관리를 제공 합니다. 또한 물리적 컴퓨터를 가상 컴퓨터로 마이그레이션하는 기능도 제공 합니다. 이 프로세스를 P2V 변환 (물리적 컴퓨터를 가상 컴퓨터로 변환) 이라고 합니다. P2V 변환 프로세스 중에는 새 가상 컴퓨터와 마이그레이션되는 실제 도메인 컨트롤러를 동시에 실행 하지 않아야 하므로 usn [및 Usn 롤백](#usn-and-usn-rollback)에 설명 된 usn 롤백 상황을 피할 수 있습니다.

도메인 컨트롤러를 다시 켤 때 디렉터리 데이터를 일관 되 게 유지 하려면 오프 라인 모드를 사용 하 여 P2V 변환을 수행 해야 합니다. 물리적 서버 변환 마법사에서 오프 라인 모드 옵션을 제공 하 고 권장 합니다. 온라인 모드와 오프 라인 모드 간의 차이점에 대 한 자세한 내용은 [P2V: VMM에서 물리적 컴퓨터를 가상 컴퓨터로 변환](https://go.microsoft.com/fwlink/?linkid=155072)을 참조하십시오. P2V 변환을 수행 하는 동안 가상 컴퓨터가 네트워크에 연결 되어 있지 않아야 합니다. P2V 변환 프로세스를 완료 하 고 확인 한 후에만 가상 컴퓨터의 네트워크 어댑터를 사용 하도록 설정 해야 합니다. 이 시점에서 물리적 원본 컴퓨터는 꺼집니다. 하드 디스크를 다시 포맷 하기 전에 물리적 원본 컴퓨터를 다시 네트워크로 다시 전환 하지 마십시오.

> [!NOTE]
> USN 롤백을 만들 때의 위험을 실행 하지 않는 새 가상 Dc를 만드는 방법에는 더 안전 합니다. 가상 DC가 이미 하나 이상 있는 경우 정기적으로 승격 하 고, IfM (미디어에서 설치)에서 프로 모션을 설정 하 고, 도메인 컨트롤러 복제를 사용 하 여 새 가상 DC를 설정할 수 있습니다.
이를 통해 하드웨어 또는 플랫폼 관련 문제에 대 한 문제를 방지할 수 있습니다. 이러한 문제는 P2V 변환 된 가상 게스트가 발생할 수 있습니다.

> [!WARNING]
> Active Directory 복제와 관련 된 문제를 방지 하려면 특정 시점에 지정 된 네트워크에 지정 된 도메인 컨트롤러의 인스턴스 (실제 또는 가상) 하나만 존재 하는지 확인 합니다.
> 이전 복제본의 문제가 발생할 가능성을 낮출 수 있습니다.
> 
> - 새 가상 DC를 실행 하는 경우 다음을 사용 하 여 컴퓨터 계정 암호를 두 번 변경 합니다. netdom resetpwd/Server: < 도메인 컨트롤러 > ...
> - 새 가상 게스트를 내보내고 가져와 새 생성 ID가 되도록 하 고 따라서 데이터베이스 호출 ID를 만듭니다.
> 

## <a name="using-p2v-migration-to-create-test-environments"></a>P2V 마이그레이션을 사용 하 여 테스트 환경 만들기

VMM을 통해 P2V 마이그레이션을 사용 하 여 테스트 환경을 만들 수 있습니다. 프로덕션 도메인 컨트롤러를 영구적으로 중단 하지 않고 테스트 환경을 만들기 위해 물리적 컴퓨터에서 가상 컴퓨터로 프로덕션 도메인 컨트롤러를 마이그레이션할 수 있습니다. 그러나 동일한 도메인 컨트롤러의 두 인스턴스가 존재 하는 경우 테스트 환경은 프로덕션 환경과 다른 네트워크에 있어야 합니다. 테스트 및 프로덕션 환경에 영향을 줄 수 있는 USN 롤백을 방지 하려면 P2V 마이그레이션을 사용 하 여 테스트 환경을 만들 때 주의 해야 합니다. 다음은 P2V를 사용 하 여 테스트 환경을 만드는 데 사용할 수 있는 메서드입니다.

각 도메인의 단일 프로덕션 도메인 컨트롤러는 물리적 컴퓨터에서 가상으로 마이그레이션 섹션에 설명 된 지침에 따라 P2V를 사용 하 여 테스트 가상 컴퓨터로 마이그레이션됩니다. 물리적 프로덕션 컴퓨터와 테스트 가상 컴퓨터는 다시 온라인 상태가 될 때 서로 다른 네트워크에 있어야 합니다. 테스트 환경에서 USN 롤백을 방지 하려면 물리적 컴퓨터에서 가상 컴퓨터로 마이그레이션할 모든 도메인 컨트롤러를 오프 라인으로 설정 해야 합니다. 이 작업은 ntds 서비스를 중지 하거나 DSRM (디렉터리 서비스 복원 모드)에서 컴퓨터를 다시 시작 하 여 수행할 수 있습니다. 도메인 컨트롤러를 오프 라인 상태로 만든 후에는 환경에 새 업데이트를 도입할 필요가 없습니다. P2V 마이그레이션 중에는 컴퓨터가 오프 라인 상태로 유지 되어야 합니다. 모든 컴퓨터가 완전히 마이그레이션될 때까지 컴퓨터를 온라인 상태로 다시 전환 하지 않습니다. USN 롤백에 대 한 자세한 내용은 USN 및 USN 롤백을 참조 하세요.

이후 테스트 도메인 컨트롤러는 테스트 환경에서 복제본으로 승격 되어야 합니다.

## <a name="time-service"></a>시간 서비스

도메인 컨트롤러로 구성 된 가상 컴퓨터의 경우 도메인 컨트롤러 역할을 하는 게스트 운영 체제와 호스트 시스템 간의 시간 동기화를 사용 하지 않도록 설정 하는 것이 좋습니다. 이렇게 하면 게스트 도메인 컨트롤러에서 도메인 계층 구조와 시간을 동기화 할 수 있습니다.

Hyper-v 시간 동기화 공급자를 사용 하지 않도록 설정 하려면 VM을 종료 하 고 Integration Services의 시간 동기화 확인란의 선택을 취소 합니다.

> [!NOTE]
> 이 지침은 이전에 호스트 간의 시간 동기화를 부분적으로 사용 하지 않도록 설정 하는 것이 아니라 도메인 계층 구조 에서만 게스트 도메인 컨트롤러에 대 한 시간 동기화에 대 한 현재 권장 사항을 반영 하도록 업데이트 되었습니다. 시스템 및 게스트 도메인 컨트롤러.

## <a name="storage"></a>스토리지

도메인 컨트롤러 가상 컴퓨터의 성능을 최적화 하 고 Active Directory 쓰기의 내구성을 보장 하려면 운영 체제, Active Directory 및 VHD 파일을 저장 하는 데 다음 권장 사항을 사용 합니다.

- **게스트 저장소**. 운영 체제 파일과 별도의 가상 디스크에 Active Directory 데이터베이스 파일 (ntds.dit), 로그 파일 및 SYSVOL 파일을 저장 합니다. 가상 SCSI 컨트롤러에 연결 된 두 번째 VHD를 만들고 가상 컴퓨터의 가상 SCSI 디스크에 데이터베이스, 로그 및 SYSVOL을 저장 합니다. 가상 SCSI 디스크는 가상 IDE에 비해 향상 된 성능을 제공 하며 FUA (강제 단위 액세스)를 지원 합니다. FUA를 사용 하면 운영 체제가 모든 캐싱 메커니즘을 우회 하 여 미디어에서 직접 데이터를 쓰고 읽을 것입니다.

  > [!NOTE]
  > 가상 DC 게스트에 Bitlocker를 사용 하려는 경우 추가 볼륨이 "자동 잠금 해제"를 사용 하도록 구성 되어 있는지 확인 해야 합니다.
  > 자동 잠금 해제를 구성 하는 방법에 대 한 자세한 내용은 [BitLockerAutoUnlock](https://docs.microsoft.com/powershell/module/bitlocker/enable-bitlockerautounlock) 를 참조 하세요.

- **VHD 파일의 호스트 저장소**입니다. 관련 호스트 저장소 권장 사항은 VHD 파일의 저장소 주소입니다. 성능을 최대화 하려면 호스트 Windows 운영 체제가 설치 된 시스템 디스크와 같이 다른 서비스 또는 응용 프로그램에서 자주 사용 하는 디스크에 VHD 파일을 저장 하지 마십시오. 각 VHD 파일을 호스트 운영 체제와 다른 VHD 파일의 별도 파티션에 저장 합니다. 이상적인 구성은 별도의 실제 드라이브에 각 VHD 파일을 저장 하는 것입니다.  

  또한 호스트 실제 디스크 시스템은 가상화 된 워크 로드 데이터 무결성의 요구 사항을 충족 하기 위해 다음 조건 중 **하나** 이상을 충족 해야 합니다.  

   - 시스템에서 서버 클래스 디스크 (SCSI, 파이버 채널)를 사용 합니다.  
   - 시스템은 디스크가 배터리 지원 캐싱 호스트 버스 어댑터 (HBA)에 연결 되어 있는지를 확인할 수 있습니다.  
   - 시스템에서는 저장소 컨트롤러 (예: RAID 시스템)를 저장 장치로 사용 합니다.  
   - 시스템은 디스크에 대 한 전원이 UPS (무정전 전원 공급 장치)로 보호 되는지 확인할 수 있습니다.  
   - 시스템이 디스크의 쓰기 캐싱 기능을 사용 하지 않도록 설정 되어 있는지 확인할 수 있습니다.  

- **VHD 및 통과 디스크를 수정**했습니다. 가상 컴퓨터에 대 한 저장소를 구성 하는 방법에는 여러 가지가 있습니다. VHD 파일을 사용 하는 경우 고정 크기 Vhd의 메모리가 생성 될 때 할당 되기 때문에 고정 크기 Vhd는 동적 Vhd 보다 더 효율적입니다. 가상 머신이 실제 저장소 미디어에 액세스 하는 데 사용할 수 있는 통과 디스크는 성능을 위해 훨씬 더 최적화 되었습니다. 통과 디스크는 기본적으로 가상 컴퓨터에 연결 된 실제 디스크 또는 Lun (논리 단위 번호)입니다. 통과 디스크는 스냅숏 기능을 지원 하지 않습니다. 따라서 도메인 컨트롤러와의 스냅숏을 사용 하는 것은 권장 되지 않으므로 통과 디스크는 선호 되는 하드 디스크 구성입니다.  

Active Directory 데이터의 손상 가능성을 줄이려면 가상 SCSI 컨트롤러를 사용 합니다.

   - 가상 도메인 컨트롤러를 호스트 하는 Hyper-v 서버에서 IDE/ATA 드라이브와는 달리 SCSI 실제 드라이브를 사용 합니다. SCSI 드라이브를 사용할 수 없는 경우 가상 도메인 컨트롤러를 호스트 하는 ATA/IDE 드라이브에서 쓰기 캐싱이 사용 되지 않도록 설정 되어 있는지 확인 합니다. 자세한 내용은 [이벤트 ID 1539 – 데이터베이스 무결성](https://go.microsoft.com/fwlink/?linkid=162419)을 참조 하세요.
   - Active Directory 쓰기의 내구성을 보장 하려면 Active Directory 데이터베이스, 로그 및 SYSVOL을 가상 SCSI 디스크에 배치 해야 합니다. 가상 SCSI 디스크는 강제 단위 액세스 (FUA)를 지원 합니다. FUA를 사용 하면 운영 체제가 모든 캐싱 메커니즘을 우회 하 여 미디어에서 직접 데이터를 쓰고 읽을 것입니다.  

## <a name="operational-considerations-for-virtualized-domain-controllers"></a>가상화 된 도메인 컨트롤러에 대 한 운영 고려 사항

가상 컴퓨터에서 실행 되는 도메인 컨트롤러에는 물리적 컴퓨터에서 실행 되는 도메인 컨트롤러에 적용 되지 않는 운영 제한이 있습니다. 가상화 된 도메인 컨트롤러를 사용 하는 경우 사용할 수 없는 몇 가지 가상화 소프트웨어 기능 및 사례가 있습니다.

   - 포리스트의 삭제 표시 수명 보다 오래 지속 되는 기간 동안 가상 컴퓨터에 도메인 컨트롤러의 저장 된 상태를 일시 중지, 중지 또는 저장 하 고 일시 중지 또는 저장 된 상태에서 다시 시작 하지 마십시오. 이렇게 하면 복제에 방해가 될 수 있습니다. 포리스트의 삭제 표시 수명을 확인 하는 방법에 대 한 자세한 내용은 [포리스트의 삭제 표시 수명 확인](https://go.microsoft.com/fwlink/?linkid=137177)을 참조 하세요.  
   - Vhd (가상 하드 디스크)를 복사 하거나 복제 하지 마십시오. 게스트 VM에 대 한 보호 기능을 사용 하는 경우에도 개별 Vhd를 복사 하 여 USN 롤백이 발생할 수 있습니다.
   - 가상 도메인 컨트롤러의 스냅숏을 만들거나 사용 하지 마세요. 기술적으로는 Windows Server 2012 이상에서 지원 되지만 좋은 백업 전략을 대체 하지는 않습니다. DC 스냅숏을 만들거나 스냅숏을 복원 하는 이유는 다음과 같습니다.
   - 도메인 컨트롤러로 구성 된 가상 머신에서 차이점 보관용 디스크 VHD를 사용 하지 마세요. 이렇게 하면 이전 버전으로 쉽게 되돌릴 수 있으며 성능도 저하 됩니다.  
   - 도메인 컨트롤러를 실행 하는 가상 머신에서는 내보내기 기능을 사용 하지 마십시오.  
   - 도메인 컨트롤러를 복원 하거나 지원 되는 백업을 사용 하는 것 외에 다른 방법으로 Active Directory 데이터베이스의 내용을 롤백해야 합니다. 자세한 내용은 [가상화 된 도메인 컨트롤러에 대 한 백업 및 복원 고려 사항](#backup-and-restore-practices-to-avoid)을 참조 하세요.  

이러한 모든 권장 사항은 USN (업데이트 시퀀스 번호) 롤백이 발생 하지 않도록 하는 데 도움이 됩니다. USN 롤백에 대 한 자세한 내용은 USN 및 USN 롤백을 참조 하세요.

## <a name="backup-and-restore-considerations-for-virtualized-domain-controllers"></a>가상화 된 도메인 컨트롤러에 대 한 백업 및 복원 고려 사항

모든 환경에서 도메인 컨트롤러를 백업 하는 것은 중요 한 요구 사항입니다. 백업은 도메인 컨트롤러 오류 또는 관리 오류 발생 시 데이터 손실을 방지 합니다. 이러한 이벤트가 발생 하는 경우 오류 또는 오류 이전의 특정 시점으로 도메인 컨트롤러의 시스템 상태를 롤백해야 합니다. 도메인 컨트롤러를 정상 상태로 복원 하는 데 지원 되는 방법은 Windows Server 백업와 같은 Active Directory 호환 백업 응용 프로그램을 사용 하 여 현재 도메인 설치에서 시작 된 시스템 상태 백업을 복원 하는 것입니다. controller. Active Directory Domain Services (AD DS)에서 Windows Server 백업를 사용 하는 방법에 대 한 자세한 내용은 [AD DS 백업 및 복구 단계별 가이드](https://go.microsoft.com/fwlink/?LinkId=138501)를 참조 하세요.

가상 컴퓨터 기술을 사용 하는 경우 Active Directory 복원 작업의 특정 요구 사항이 추가 된 의미에 따라 수행 됩니다. 예를 들어 VHD (가상 하드 디스크) 파일의 복사본을 사용 하 여 도메인 컨트롤러를 복원 하는 경우 복원 된 후 도메인 컨트롤러의 데이터베이스 버전을 업데이트 하는 중요 한 단계를 무시 합니다. 복제는 부적절 한 추적 번호를 사용 하 여 계속 진행 되므로 도메인 컨트롤러 복제본 간에 일관 되지 않은 데이터베이스가 생성 됩니다. 대부분의 경우이 문제는 복제 시스템에서 검색 되지 않으며, 도메인 컨트롤러 간의 불일치에도 불구 하 고 오류는 보고 되지 않습니다.

가상화 된 도메인 컨트롤러의 백업 및 복원을 수행 하는 데 지원 되는 한 가지 방법이 있습니다.

1. 게스트 운영 체제에서 Windows Server 백업를 실행 합니다.  

Windows Server 2012 이상 Hyper-v 호스트 및 게스트를 사용 하는 경우 스냅숏, 게스트 VM 내보내기 및 가져오기와 Hyper-v 복제를 사용 하 여 도메인 컨트롤러의 백업을 지원할 수 있습니다. 이러한 모든 것은 적절 한 백업 기록을 만드는 데 적합 하지 않습니다. 단, 게스트 VM 내보내기는 약간 예외입니다.

Windows Server 2016 Hyper-v를 사용 하는 경우 Hyper-v 서버가 게스트의 VSS 기반 백업을 트리거하는 "프로덕션 스냅숏"이 지원 되며 게스트가 스냅숏으로 수행 되 면 호스트는 Vhd를 인출 하 여 백업 위치에 저장 합니다.

이 기능은 Windows Server 2012 이상에서 작동 하지만 Bitlocker와 호환 되지 않습니다.

- VSS 스냅 샷을 수행할 때 AD는 스냅숏 후 작업을 수행 하 여 데이터베이스를 백업에서 가져온 것으로 표시 하거나, RODC에 대 한 IFM 원본을 준비 하는 경우 데이터베이스에서 자격 증명을 제거 합니다.
- Hyper-v에서이 작업에 대 한 스냅숏 볼륨을 탑재 하면 암호화 되지 않은 액세스를 위해 볼륨을 잠금 해제 하는 기능이 없습니다. 따라서 AD 데이터베이스 엔진은 데이터베이스에 대 한 액세스를 실패 하 고 결국 스냅숏에 실패 합니다.

> [!NOTE]
> 이전에 언급 한 차폐 VM 프로젝트에는 게스트 VM의 최대 데이터 보호에 대 한 비 목표로 Hyper-v 호스트 기반 백업이 있습니다.

## <a name="backup-and-restore-practices-to-avoid"></a>방지 하기 위한 백업 및 복원 방법

앞에서 설명한 것 처럼 가상 컴퓨터에서 실행 되는 도메인 컨트롤러에는 물리적 컴퓨터에서 실행 되는 도메인 컨트롤러에 적용 되지 않는 제한이 있습니다. 가상 도메인 컨트롤러를 백업 하거나 복원할 때 사용 하지 않아야 하는 특정 가상화 소프트웨어 기능 및 사례가 있습니다.

   - 정기적으로 백업 하는 대신 도메인 컨트롤러의 VHD 파일을 복사 하거나 복제 하지 마십시오. VHD 파일을 복사 하거나 복제 하는 경우이 파일은 오래 된 상태가 됩니다. 그런 다음 표준 모드에서 VHD를 시작 하는 경우 USN 롤백이 발생 합니다. Windows Server 백업 기능 사용과 같은 Active Directory Domain Services (AD DS)에서 지원 되는 적절 한 백업 작업을 수행 해야 합니다.  
   - 도메인 컨트롤러로 구성 된 가상 컴퓨터를 복원 하는 백업으로 Snapshot 기능을 사용 하지 마세요. Windows Server 2008 R2이 하 버전을 사용 하 여 가상 컴퓨터를 이전 상태로 되돌릴 때 복제에 문제가 발생 합니다. 자세한 내용은 [USN 및 USN 롤백](#usn-and-usn-rollback)을 참조하세요. 스냅숏을 사용 하 여 RODC (읽기 전용 도메인 컨트롤러)를 복원 해도 복제 문제가 발생 하지는 않지만이 복원 방법은 사용 하지 않는 것이 좋습니다.  

## <a name="restoring-a-virtual-domain-controller"></a>가상 도메인 컨트롤러 복원

오류가 발생할 때 도메인 컨트롤러를 복원 하려면 시스템 상태를 정기적으로 백업 해야 합니다. 시스템 상태에는 데이터 및 로그 파일, 레지스트리, 시스템 볼륨 (SYSVOL 폴더) 및 운영 체제의 다양 한 요소가 Active Directory 포함 됩니다. 이 요구 사항은 실제 및 가상 도메인 컨트롤러에 대해 동일 합니다. Active Directory 호환 되는 백업 응용 프로그램에서 수행 하는 시스템 상태 복원 절차는 복원 프로세스 후 복제에 대 한 알림을 포함 하 여 로컬 및 복제 된 Active Directory 데이터베이스의 일관성을 보장 하도록 설계 되었습니다. 호출 ID의 파트너를 다시 설정 합니다. 그러나 가상 호스팅 환경 및 디스크 또는 운영 체제 이미징 응용 프로그램을 사용 하면 관리자가 도메인 컨트롤러 시스템 상태를 복원할 때 일반적으로 발생 하는 검사 및 유효성 검사를 우회할 수 있습니다.

도메인 컨트롤러 가상 컴퓨터가 실패 하 고 USN (업데이트 시퀀스 번호) 롤백이 발생 하지 않으면 가상 컴퓨터를 복원 하는 데 다음과 같은 두 가지 지원 되는 상황이 발생 합니다.

   - 오류를 이전의 하는 유효한 시스템 상태 데이터 백업이 있는 경우 백업을 만드는 데 사용한 백업 유틸리티의 복원 옵션을 사용 하 여 시스템 상태를 복원할 수 있습니다. 시스템 상태 데이터 백업은 삭제 표시 수명 범위 내에 Active Directory 호환 되는 백업 유틸리티를 사용 하 여 생성 되어야 합니다 .이는 기본적으로 180 일 미만입니다. 최소 30 분 마다 도메인 컨트롤러를 백업 해야 합니다. 포리스트의 특정 삭제 표시 수명을 결정 하는 방법에 대 한 지침은 [포리스트의 삭제 표시 수명 확인](https://go.microsoft.com/fwlink/?linkid=137177)을 참조 하세요.  
   - VHD 파일의 작업 복사본을 사용할 수 있지만 시스템 상태 백업을 사용할 수 없는 경우 기존 가상 컴퓨터를 제거할 수 있습니다. VHD의 이전 복사본을 사용 하 여 기존 가상 컴퓨터를 복원 하지만, 다음 섹션에 설명 된 대로 DSRM (디렉터리 서비스 복원 모드)에서 시작 하 고 레지스트리를 올바르게 구성 해야 합니다. 그런 다음 표준 모드에서 도메인 컨트롤러를 다시 시작 합니다.

다음 그림의 프로세스를 사용 하 여 가상화 된 도메인 컨트롤러를 복원 하는 가장 좋은 방법을 결정 합니다.

![](media/virtualized-domain-controller-architecture/Dd363553.85c97481-7b95-4705-92a7-006e48bc29d0(WS.10).gif)

Rodc의 경우 복원 프로세스와 결정이 더 간단 합니다.

![](media/virtualized-domain-controller-architecture/Dd363553.4c5c5eda-df95-4c6b-84e0-d84661434e5d(WS.10).gif)

## <a name="restoring-the-system-state-backup-of-a-virtual-domain-controller"></a>가상 도메인 컨트롤러의 시스템 상태 백업 복원

도메인 컨트롤러 가상 컴퓨터에 대해 유효한 시스템 상태 백업이 존재 하는 경우 VHD 파일을 백업 하는 데 사용한 백업 도구에 지정 된 복원 절차를 수행 하 여 백업을 안전 하 게 복원할 수 있습니다.

> [!IMPORTANT]
> 도메인 컨트롤러를 제대로 복원 하려면 DSRM에서 시작 해야 합니다. 도메인 컨트롤러를 표준 모드로 시작 하도록 허용 해서는 안 됩니다. 시스템 시작 중 DSRM을 입력할 기회가 없으면 도메인 컨트롤러의 가상 컴퓨터를 해제 한 후 표준 모드로 완전히 시작할 수 있습니다. 도메인 컨트롤러를 네트워크에서 분리 하는 경우에도 표준 모드에서 도메인 컨트롤러를 시작 하면 해당 Usn이 증가 하므로 DSRM에서 도메인 컨트롤러를 시작 하는 것이 중요 합니다. USN 롤백에 대 한 자세한 내용은 USN 및 USN 롤백을 참조 하세요. 

## <a name="to-restore-the-system-state-backup-of-a-virtual-domain-controller"></a>가상 도메인 컨트롤러의 시스템 상태 백업을 복원 하려면

1. 도메인 컨트롤러의 가상 컴퓨터를 시작 하 고 F5 키를 눌러 Windows 부팅 관리자 화면에 액세스 합니다. 연결 자격 증명을 입력 해야 하는 경우 가상 머신에서 **일시 중지** 단추를 즉시 클릭 하 여 계속 시작 하지 않도록 합니다. 그런 다음 연결 자격 증명을 입력 하 고 가상 머신에서 **재생** 단추를 클릭 합니다. 가상 컴퓨터 창 내부를 클릭 한 다음 F5 키를 누릅니다.

   Windows 부팅 관리자 화면이 표시 되지 않고 도메인 컨트롤러가 표준 모드에서 시작 되는 경우 가상 컴퓨터를 끄고 시작을 완료 하지 않도록 합니다. Windows 부팅 관리자 화면에 액세스할 수 있을 때까지 필요한 만큼이 단계를 반복 합니다. Windows 오류 복구 메뉴에서 DSRM에 액세스할 수 없습니다. 따라서 Windows 오류 복구 메뉴가 표시 되 면 가상 컴퓨터를 끄고 다시 시도 하십시오.

2. Windows 부팅 관리자 화면에서 F8 키를 눌러 고급 부팅 옵션에 액세스 합니다.
3. **고급 부팅 옵션** 화면에서 **디렉터리 서비스 복원 모드**를 선택 하 고 enter 키를 누릅니다. DSRM에서 도메인 컨트롤러를 시작 합니다.
4. 시스템 상태 백업을 만드는 데 사용 되는 도구에 적절 한 복원 방법을 사용 합니다. Windows Server 백업 사용 하는 경우 [AD DS의 비정식 복원 수행](https://go.microsoft.com/fwlink/?linkid=132637)을 참조 하세요.

## <a name="restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available"></a>적절 한 시스템 상태 데이터 백업을 사용할 수 없는 경우 가상 도메인 컨트롤러 복원

가상 컴퓨터 오류를 이전의 하는 시스템 상태 데이터 백업이 없는 경우 이전 VHD 파일을 사용 하 여 가상 컴퓨터에서 실행 되는 도메인 컨트롤러를 복원할 수 있습니다. 가능 하면, 작업을 수행 하는 동안 문제가 발생 하거나 단계를 누락 하는 경우 VHD의 복사본을 만들면 복사 된 VHD를 다시 시도할 수 있습니다.

> [!IMPORTANT]
> - 정기적으로 계획 되 고 예약 된 백업에 대 한 대체 방법으로 다음 절차를 사용 하지 않는 것이 좋습니다.
> - **다음 절차를 사용 하 여 수행 되는 복원은 Microsoft에서 지원 되지 않으며 다른 대안이 없는 경우에만 사용 해야 합니다.**
> - 복원 하려는 VHD의 복사본이 모든 가상 머신에서 표준 모드로 시작 된 경우에는이 절차를 사용 하지 마세요.

## <a name="to-restore-a-previous-version-of-a-virtual-domain-controller-vhd-without-system-state-data-backup"></a>시스템 상태 데이터 백업 없이 가상 도메인 컨트롤러 VHD의 이전 버전을 복원 하려면

1. 이전 VHD를 사용 하 여 이전 섹션에서 설명한 대로 DSRM에서 가상 도메인 컨트롤러를 시작 합니다. 표준 모드에서 도메인 컨트롤러를 시작할 수 없습니다. Windows 부팅 관리자 화면이 표시 되지 않은 경우 도메인 컨트롤러가 표준 모드로 시작 되기 시작 하면 가상 컴퓨터를 해제 하 여 시작을 완료 하지 못하게 합니다. DSRM을 입력 하는 방법에 대 한 자세한 지침은 이전 섹션을 참조 하세요.
2. 레지스트리 편집기를 엽니다. 레지스트리 편집기를 열려면 **시작**, **실행**을 차례로 클릭 하 고 **regedit**를 입력 한 다음 확인을 클릭 합니다. **사용자 계정 컨트롤** 대화 상자가 나타나면 원하는 작업이 표시되었는지 확인한 다음 **예**를 클릭합니다. 레지스트리 편집기에서 다음 경로를 확장 합니다. **HKEY\_로컬컴퓨터시스템\\CurrentControlSet 서비스 NTDS매개\\변수\\\\\_\\** **DSA 이전 복원 횟수**라는 값을 찾습니다. 값이 있으면 설정을 기록해 둡니다. 값이 없는 경우 설정은 기본값 (0)과 같습니다. 값이 표시 되지 않는 경우에는 값을 추가 하지 마세요.
3. **매개 변수** 키를 마우스 오른쪽 단추로 클릭 하 고 **새로 만들기**를 클릭 한 다음 **DWORD (32 비트) 값**을 클릭 합니다.
4. **백업에서 복원**된 새 이름 데이터베이스를 입력 한 다음 enter 키를 누릅니다.
5. 방금 만든 값을 두 번 클릭 하 여 **DWORD (32 비트) 값 편집** 대화 상자를 연 다음 **값 데이터** 상자에 **1** 을 입력 합니다. **백업 항목에서 복원 된 데이터베이스** 옵션은 Windows 2000 Server 서비스 팩 4 (SP4)를 실행 하는 도메인 컨트롤러에서 사용할 수 있습니다. windows Server 2003 [에서 USN 롤백을 검색 하 고 복구 하는 방법에 포함 된 업데이트를 포함 합니다. Windows server 2003, Windows Server 2008 및 windows server 2008 R2](https://go.microsoft.com/fwlink/?linkid=137182) (Microsoft 기술 자료 설치 및 windows server 2008)
6. 표준 모드에서 도메인 컨트롤러를 다시 시작 합니다.
7. 도메인 컨트롤러가 다시 시작 되 면 이벤트 뷰어를 엽니다. 이벤트 뷰어를 열려면 **시작**, **제어판**을 차례로 클릭하고 **관리 도구**를 두 번 클릭한 다음 **이벤트 뷰어**를 두 번 클릭합니다.
8. **응용 프로그램 및 서비스 로그**를 확장 하 고 **디렉터리 서비스** 로그를 클릭 합니다. 세부 정보 창에 이벤트가 표시 되는지 확인 합니다.
9. **디렉터리 서비스** 로그를 마우스 오른쪽 단추로 클릭 한 다음 **찾기**를 클릭 합니다. **찾을 내용**에 **1109**을 입력 하 고 **다음 찾기**를 클릭 합니다.
10. 적어도 이벤트 ID 1109 항목이 표시 되어야 합니다. 이 항목이 표시 되지 않으면 다음 단계를 진행 합니다. 그렇지 않으면 항목을 두 번 클릭 한 다음 InvocationID에 대 한 업데이트를 확인 하는 텍스트를 검토 합니다.

    ```
    Active Directory has been restored from backup media, or has been configured to host an application partition. 
    The invocationID attribute for this directory server has been changed. 
    The highest update sequence number at the time the backup was created is <time>

    InvocationID attribute (old value):<Previous InvocationID value>
    InvocationID attribute (new value):<New InvocationID value>
    Update sequence number:<USN>

    The InvocationID is changed when a directory server is restored from backup media or is configured to host a writeable application directory partition.
    ```

11. 이벤트 뷰어를 닫습니다.
12. 레지스트리 편집기를 사용 하 여 **DSA 이전 복원 횟수** 의 값이 이전 값에 1을 더한 값과 같은지 확인 합니다. 올바른 값이 아니고 이벤트 뷰어에서 이벤트 ID 1109에 대 한 항목을 찾을 수 없는 경우 도메인 컨트롤러의 서비스 팩이 최신 상태 인지 확인 하십시오. 동일한 VHD에서이 절차를 다시 시도할 수 없습니다. 1 단계에서 시작 하 여 표준 모드로 시작 되지 않은 VHD 또는 vhd의 복사본을 다시 시도할 수 있습니다.
13. 레지스트리 편집기를 닫습니다.

## <a name="usn-and-usn-rollback"></a>USN 및 USN 롤백

이 섹션에서는 이전 버전의 가상 컴퓨터를 사용 하는 Active Directory 데이터베이스의 잘못 된 복원으로 인해 발생할 수 있는 복제 문제에 대해 설명 합니다. Active Directory 복제 프로세스에 대 한 자세한 내용은 [Active Directory 복제 개념](../replication/active-directory-replication-concepts.md) 을 참조 하십시오.

## <a name="usns"></a>Usn

Active Directory Domain Services (AD DS)는 Usn (업데이트 시퀀스 번호)을 사용 하 여 도메인 컨트롤러 간의 데이터 복제를 추적 합니다. 디렉터리의 데이터가 변경 될 때마다 USN이 증가 하 여 변경 내용이 적용 되었음을 표시 합니다.

대상 도메인 컨트롤러에서 저장 하는 각 디렉터리 파티션에 대해 Usn은 도메인 컨트롤러가 해당 데이터베이스에 대해 도입 된 최신 원래 업데이트 및 복제본을 저장 하는 다른 모든 도메인 컨트롤러의 상태를 추적 하는 데 사용 됩니다. 디렉터리 파티션입니다. 도메인 컨트롤러는 변경 내용을 서로 복제 하는 경우 복제 파트너에 게 각 파트너 로부터 받은 마지막 변경의 USN 보다 큰 usn을 사용 하 여 변경 내용을 쿼리 합니다.

다음 두 복제 메타 데이터 테이블에는 Usn이 포함 되어 있습니다. 원본 및 대상 도메인 컨트롤러는이를 사용 하 여 대상 도메인 컨트롤러에 필요한 업데이트를 필터링 합니다.

1. **최신 벡터**: 대상 도메인 컨트롤러에서 모든 원본 도메인 컨트롤러 로부터 받은 원래 업데이트를 추적 하기 위해 유지 하는 테이블입니다. 대상 도메인 컨트롤러는 디렉터리 파티션에 대 한 변경 내용을 요청 하면 원본 도메인 컨트롤러에 최신 벡터를 제공 합니다. 그런 다음 원본 도메인 컨트롤러는이 값을 사용 하 여 대상 도메인 컨트롤러에 보내는 업데이트를 필터링 합니다. 원본 도메인 컨트롤러는 대상 도메인 컨트롤러에서 모든 도메인 컨트롤러와 동기화 된 것을 알 수 있도록 성공적인 복제 주기를 완료할 때 최신 벡터를 대상으로 전송 합니다. 원래 업데이트와 업데이트는 원본과 같은 수준에 있습니다.  
2. **상위 워터 마크**: 특정 파티션에 대 한 특정 원본 도메인 컨트롤러에서 받은 가장 최근 변경 내용을 추적 하기 위해 대상 도메인 컨트롤러가 유지 관리 하는 값입니다. 상위 워터 마크는 원본 도메인 컨트롤러에서 대상 도메인 컨트롤러가 이미 받은 변경 내용을 전송 하지 못하도록 합니다.  

## <a name="directory-database-identity"></a>디렉터리 데이터베이스 id

Usn 외에도 도메인 컨트롤러는 원본 복제 파트너의 디렉터리 데이터베이스를 추적 합니다. 서버에서 실행 되는 디렉터리 데이터베이스의 id는 서버 개체 자체의 id와는 별도로 유지 관리 됩니다. 각 도메인 컨트롤러의 디렉터리 데이터베이스 id는 NTDS 설정 개체의 **invocationID** 특성에 저장 됩니다 .이 특성은 다음 LDAP (Lightweight Directory Access Protocol) 경로 아래에 있습니다. CN = NTDS settings, Cn = ServerName, cn = Servers, cn =*SiteName*, Cn = Sites, Cn = Configuration, Dc =*ForestRootDomain*. 서버 개체 id는 NTDS 설정 개체의 **objectGUID** 특성에 저장 됩니다. 서버 개체의 id는 변경 되지 않습니다. 그러나 서버에서 시스템 상태 복원 절차를 수행 하거나 응용 프로그램 디렉터리 파티션을 추가한 후 서버에서 제거 된 후 나중에 다시 추가 하는 경우 디렉터리 데이터베이스의 id가 변경 됩니다. (기타 시나리오: HyperV 인스턴스가 가상 DC의 VHD를 포함 하는 파티션에서 VSS 기록기를 트리거하는 경우 게스트는 자체 VSS 기록기를 트리거합니다 (위의 백업/복원에 사용 되는 것과 동일한 메커니즘). 그러면 invocationID가 다시 설정

따라서 **invocationID** 는 도메인 컨트롤러의 원래 업데이트 집합을 디렉터리 데이터베이스의 특정 버전과 효과적으로 연결 합니다. 최신 벡터 및 상위 워터 마크 테이블은 각각 **invocationID** 및 DC GUID를 사용 하 여 도메인 컨트롤러가 복제 정보를 가져올 Active Directory 데이터베이스의 복사본을 알 수 있도록 합니다.

**InvocationID** 는 **repadmin/showrepl**명령을 실행 한 후 출력의 위쪽에 표시 되는 guid (globally unique identifier) 값입니다. 다음 텍스트는 명령의 예제 출력을 나타냅니다.

   ```
   Repadmin: running command /showrepl against full DC local host
   Default-First-Site-Name\VDC1
   DSA Options: IS_GC
   DSA object GUID: 966651f3-a544-461f-9f2c-c30c91d17818
   DSA invocationID: b0d9208b-8eb6-4205-863d-d50801b325a9
   ```

AD DS 도메인 컨트롤러에서 제대로 복원 되 면 **invocationID** 가 다시 설정 됩니다. 이러한 변경으로 인해 복제 트래픽이 증가 하 게 됩니다 .이 기간에는 복제 중인 파티션의 크기를 기준으로 합니다.

예를 들어 VDC1와 DC2는 동일한 도메인에 있는 두 개의 도메인 컨트롤러 라고 가정 합니다. 다음 그림은 적절 한 복원 상황에서 invocationID 값이 다시 설정 될 때 VDC1에 대 한 DC2의 인식을 보여 줍니다.

![](media/virtualized-domain-controller-architecture/Dd363553.ca71fc12-b484-47fb-991c-5a0b7f516366(WS.10).gif)

## <a name="usn-rollback"></a>USN 롤백

USN 롤백은 usn의 일반 업데이트가 우회할 하 고 도메인 컨트롤러가 최신 업데이트 보다 낮은 USN을 사용 하려고 할 때 발생 합니다. 대부분의 경우 포리스트의 확산을 만들기 전에 USN 롤백이 감지 되 고 복제가 중지 됩니다. 

USN 롤백은 여러 가지 방법으로 발생할 수 있습니다. 예를 들어 이전 VHD (가상 하드 디스크) 파일을 사용 하거나 물리적 컴퓨터를 가상 컴퓨터로 변환 (P2V 변환)을 수행 하는 경우에는 물리적 컴퓨터가 변환 후 영구적으로 오프 라인 상태로 유지 됩니다. 다음 예방 조치를 수행 하 여 USN 롤백이 발생 하지 않도록 합니다.

   - Windows Server 2012 이상 버전을 실행 하지 않는 경우 도메인 컨트롤러 가상 컴퓨터의 스냅숏을 사용 하거나 사용 하지 마세요.
   - 도메인 컨트롤러 VHD 파일을 복사 하지 마십시오.  
   - Windows Server 2012 이상 버전을 실행 하지 않는 경우 도메인 컨트롤러를 실행 하는 가상 컴퓨터는 내보내지 마세요.  
   - 도메인 컨트롤러를 복원 하거나 Windows Server 백업와 같이 지원 되는 백업 솔루션 이외의 방법으로 Active Directory 데이터베이스의 내용을 롤백해야 합니다.  

일부 경우에는 USN 롤백이 감지 되지 않을 수 있습니다. 다른 경우에는 다른 복제 오류가 발생할 수 있습니다. 이러한 경우 문제의 범위를 파악 하 고 적시에 처리 해야 합니다. USN 롤백의 결과로 발생할 수 있는 느린 개체를 제거 하는 방법에 대 한 자세한 내용은 Microsoft 기술 자료에서 [오래 된 Active Directory Objects Windows Server 2003에서 이벤트 ID 1988 생성](https://go.microsoft.com/fwlink/?linkid=137185) 을 참조 하십시오.

## <a name="usn-rollback-detection"></a>USN 롤백 검색

대부분의 경우 잘못 된 복원 절차로 인해 발생 하는 **invocationID** 의 해당 다시 설정 없이 USN 롤백이 감지 됩니다. Windows Server 2008는 부적절 한 도메인 컨트롤러 복원 작업 후 부적절 한 복제에 대 한 보호를 제공 합니다. 이러한 보호는 부적절 한 복원 작업으로 인해 복제 파트너가 이미 받은 원래 변경 내용을 나타내는 낮은 Usn이 발생 한다는 사실에 의해 트리거됩니다.

Windows Server 2008 및 Windows Server 2003 s p 1에서 대상 도메인 컨트롤러가 이전에 사용 된 USN을 사용 하 여 변경 내용을 요청 하면 원본 복제 파트너의 응답이 대상 도메인 컨트롤러에 의해 해석 되어 해당 복제를 의미 합니다. 메타 데이터가 오래 되었습니다. 이는 원본 도메인 컨트롤러의 Active Directory 데이터베이스가 이전 상태로 롤백 되었음을 나타냅니다. 예를 들어 가상 컴퓨터의 VHD 파일이 이전 버전으로 롤백 되었습니다. 이 경우 대상 도메인 컨트롤러는 잘못 된 복원으로 식별 된 도메인 컨트롤러에서 다음 격리 조치를 시작 합니다.

   - AD DS Net Logon 서비스를 일시 중지 하 여 사용자 계정 및 컴퓨터 계정이 계정 암호를 변경 하지 못하도록 합니다. 이 작업을 수행 하면 부적절 한 복원 후에 이러한 변경 내용이 손실 되지 않습니다.  
   - AD DS 인바운드 및 아웃 바운드 Active Directory 복제를 사용 하지 않도록 설정 합니다.  
   - AD DS는 상태를 나타내기 위해 디렉터리 서비스 이벤트 로그에 이벤트 ID 2095을 생성 합니다.  

다음 그림에서는 가상 머신에서 실행 되는 대상 도메인 컨트롤러인 VDC2에서 USN 롤백이 감지 될 때 발생 하는 이벤트의 순서를 보여 줍니다. 이 그림에서 USN 롤백 검색은 복제 파트너가 VDC2에서 이전에 대상 도메인 컨트롤러에 의해 이전에 확인 된 최신 USN 값을 VDC2 경우에 발생 합니다 .이는 이라는 사실 데이터베이스가 롤백 되었음을 나타냅니다. 시간이 잘못 되었습니다.

![](media/virtualized-domain-controller-architecture/Dd363553.373b0504-43fc-40d0-9908-13fdeb7b3f14(WS.10).gif)

디렉터리 서비스 이벤트 로그에서 이벤트 ID 2095을 보고 하는 경우 다음 절차를 즉시 완료 하십시오.

## <a name="to-resolve-event-id2095"></a>이벤트 ID 2095를 해결 하려면

1. 네트워크에서 오류를 기록한 가상 컴퓨터를 격리 합니다.
2. 변경 내용이이 도메인 컨트롤러에서 시작 되 고 다른 도메인 컨트롤러에 전파 되었는지 확인 합니다. 시작 되는 가상 컴퓨터의 스냅숏 또는 복사본에 대 한 이벤트의 결과일 경우 USN 롤백이 발생 한 시간을 확인 하십시오. 그런 다음 해당 도메인 컨트롤러의 복제 파트너를 확인 하 여 이후에 복제가 발생 했는지 여부를 확인할 수 있습니다.

   Repadmin 도구를 사용 하 여 이러한 결정을 내릴 수 있습니다. Repadmin을 사용 하는 방법에 대 한 자세한 내용은 [repadmin을 사용 하 여 Active Directory 복제 모니터링 및 문제 해결](https://go.microsoft.com/fwlink/?linkid=122830)을 참조 하세요. 이를 직접 확인할 수 없는 경우 [Microsoft 지원](https://support.microsoft.com) 에 문의 하 여 도움을 받으세요.

3. 도메인 컨트롤러의 수준을 강제로 내립니다. 여기에는 도메인 컨트롤러의 메타 데이터를 정리 하 고 작업 마스터 (신축 단일 마스터 작업 또는 FSMO 라고도 함) 역할을 점유 하는 작업이 포함 됩니다. 자세한 내용은 Microsoft 기술 자료의 [Windows server 2003, Windows server 2008 및 Windows server 2008 r 2에서 usn 롤백을 검색 하 고 복구 하는 방법](https://go.microsoft.com/fwlink/?linkid=137182) 의 "usn 롤백에서 복구" 섹션을 참조 하십시오.
4. 도메인 컨트롤러에 대 한 이전 VHD 파일을 모두 삭제 합니다.

## <a name="undetected-usn-rollback"></a>검색 되지 않은 USN 롤백

다음 두 가지 상황 중 하나에서 USN 롤백이 검색 되지 않을 수 있습니다.

1. VHD 파일은 여러 위치에서 동시에 실행 되는 다른 가상 컴퓨터에 연결 됩니다.  
2. 복원 된 도메인 컨트롤러의 USN이 다른 도메인 컨트롤러에서 받은 마지막 USN을 초과 했습니다.  

첫 번째 경우에 다른 도메인 컨트롤러는 가상 컴퓨터 중 하나를 사용 하 여 복제할 수 있으며, 다른 도메인 컨트롤러에 복제 되지 않고 두 가상 컴퓨터에서 변경 내용이 발생할 수 있습니다. 이 포리스트의 차이는 검색 하기 어렵고 예측할 수 없는 디렉터리 응답을 발생 시킵니다. 물리적 컴퓨터와 가상 컴퓨터가 동일한 네트워크에서 실행 되는 경우 P2V 마이그레이션 후에 이러한 상황이 발생할 수 있습니다. 동일한 실제 도메인 컨트롤러에서 여러 가상 도메인 컨트롤러를 만든 다음 동일한 네트워크에서 실행 하는 경우에도이 문제가 발생할 수 있습니다.

두 번째 경우에서 Usn 범위는 서로 다른 두 변경 집합에 적용 됩니다. 이 작업은 검색 하지 않고도 연장 된 기간 동안 계속 될 수 있습니다. 해당 시간 동안 만들어진 개체를 수정할 때마다 느린 개체가 검색 되어 이벤트 뷰어에서 이벤트 ID 1988로 보고 됩니다. 다음 그림에서는 이러한 상황에서 USN 롤백이 감지 되지 않는 방법을 보여 줍니다.

![](media/virtualized-domain-controller-architecture/Dd363553.63565fe0-d970-4b4e-b5f3-9c76bc77e2d4(WS.10).gif)

## <a name="read-only-domain-controllers"></a>읽기 전용 도메인 컨트롤러

Rodc는 Active Directory 데이터베이스에 있는 파티션의 읽기 전용 복사본을 호스트 하는 도메인 컨트롤러입니다. Rodc는 다른 도메인 컨트롤러에 변경 내용을 복제 하지 않으므로 대부분의 USN 롤백 문제를 방지 합니다. 그러나 RODC가 USN 롤백의 영향을 받은 쓰기 가능한 도메인 컨트롤러에서 복제 되는 경우 RODC도 영향을 받습니다.

스냅숏을 사용 하 여 RODC를 복원 하는 것은 권장 되지 않습니다. Active Directory 호환 백업 응용 프로그램을 사용 하 여 RODC를 복원 합니다. 또한 쓰기 가능 도메인 컨트롤러와 마찬가지로, 삭제 표시 수명이 많은 수명 동안 RODC가 오프 라인 상태가 되지 않도록 주의를 기울여야 합니다. 이 조건으로 인해 RODC의 개체가 느려질 수 있습니다.

Rodc에 대 한 자세한 내용은 [읽기 전용 도메인 컨트롤러 계획 및 배포 가이드](../../deploy/rodc/read-only-domain-controller-updates.md)를 참조 하세요.

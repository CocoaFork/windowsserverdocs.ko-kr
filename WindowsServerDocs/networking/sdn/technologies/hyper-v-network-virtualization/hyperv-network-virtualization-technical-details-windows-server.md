---
title: Windows Server 2016의에서 Hyper-v 네트워크 가상화 기술 정보
description: 이 항목에서는 Windows Server 2016에서 Hyper-v 네트워크 가상화에 대 한 기술 정보를 제공합니다.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.service: virtual-network
ms.suite: na
ms.technology:
- networking-sdn
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 8db47479d0c6e6014a7df6cecd59b1e87920b76a
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/17/2019
ms.locfileid: "59887554"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Windows Server 2016의에서 Hyper-v 네트워크 가상화 기술 정보

>적용 대상:  Windows Server 2016

서버 가상화를 사용하면 단일 실제 호스트에서 동시에 여러 서버 인스턴스를 실행할 수 있지만 서버 인스턴스는 서로 격리됩니다. 각 가상 컴퓨터는 기본적으로 해당 가상 컴퓨터가 실제 컴퓨터에서 실행되는 유일한 서버인 것처럼 작동합니다.  
  
유사한 기능을 제공 하는 네트워크 가상화는 여러 가상 네트워크 (겹치는 IP 주소)와 잠재적으로 동일한 실행에서 실제 네트워크 인프라 및 각 가상 네트워크 작동 유일한 가상 네트워크에서 실행 되는 것 처럼, 공유 네트워크 인프라입니다. 그림 1에서는 이 관계를 보여 줍니다.  
  
![서버 가상화 대 네트워크 가상화](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  
  
그림 1: 서버 가상화 대 네트워크 가상화  
  
## <a name="hyper-v-network-virtualization-concepts"></a>Hyper-V 네트워크 가상화 개념  
Hyper-v 네트워크 가상화 (HNV), 고객 또는 테 넌 트를 enterprise 또는 datacenter에 배포 되는 IP 서브넷 집합의 "소유자"로 정의 됩니다. 회사 또는 여러 부서 또는 사업부에서 개인 데이터 센터 네트워크 격리를 필요로 하는 서비스 공급자에서 호스트 되는 공용 데이터 센터에서 테 넌 트를 사용 하 여 엔터프라이즈 고객 수 있습니다. 각 고객은 하나 이상 포함할 수도 있습니다 [가상 네트워크](#VirtualNetworks) 네트워크가 하나 이상의 구성 된 데이터 센터에 각 가상 [가상 서브넷](#VirtualSubnets)합니다.  
  
Windows Server 2016에서 사용할 수 있는 HNV 구현 두 가지가 있습니다. HNVv1 및 HNVv2 합니다.  
  
-   **HNVv1**  
  
    HNVv1은 Windows Server 2012 R2 및 System Center 2012 R2 Virtual Machine Manager (VMM)와 호환 됩니다. HNVv1에 대 한 구성을 WMI 관리 및 Windows PowerShell cmdlet (System Center VMM을 통해 지원)를 격리 설정 및 고객 주소 (CA)-가상 네트워크를 정의 합니다. 실제 주소 (PA) 매핑 및 라우팅 합니다. Windows Server 2016에서 HNVv1에 추가 된 추가 기능이 없습니다 및 없는 새로운 기능이 예정 되어 있습니다.  
    
    • 팀을 설정 하 고 HNV V1 플랫폼에서 호환 되지 않습니다.
    
    HA NVGRE 게이트웨이 사용자를 사용 하는 o 필요를 사용 하 여 LBFO 팀 또는 팀 없음. 또는
    
    o 집합을 사용 하 여 게이트웨이 사용 하 여 네트워크 컨트롤러 배포 팀 전환 합니다.

  
-   **HNVv2**  
  
    Azure 가상 필터링 플랫폼 (VFP) 전달 Hyper-v 스위치에서 확장을 사용 하 여 구현 되는 HNVv2에서 많은 새로운 기능 포함 됩니다. 새 네트워크 컨트롤러 네트워킹 SDN (소프트웨어) 스택을 포함 하는 Microsoft Azure Stack HNVv2 완벽 하 게 통합 되어 있습니다.  Microsoft를 통해 가상 네트워크 정책 이란 [네트워크 컨트롤러](../../../sdn/technologies/network-controller/Network-Controller.md) 는 RESTful NorthBound (NB) API를 사용 하 고 호스트 에이전트를 통해 여러 SouthBound 장치 인터페이스 (SBI) OVSDB를 포함 하 여에 연결 합니다. 호스트 에이전트 프로그램은 적용 되는 Hyper-v 스위치의 VFP 확장에는 정책입니다.  
  
    > [!IMPORTANT]  
    > 이 항목에서는 HNVv2에 중점을 둡니다.  
  
### <a name="VirtualNetworks"></a>가상 네트워크  
  
-   각 가상 네트워크는 하나 이상의 가상 서브넷으로 구성 됩니다. 가상 네트워크를 가상 네트워크 내의 가상 컴퓨터 서로 통신할 수 있는 격리 경계를 형성 합니다. 일반적으로이 격리를 적용 하는 분리 된 IP 주소 범위 및 802.1q Vlan을 사용 하 여 태그 또는 VLAN id입니다. 하지만 HNV를 사용 하 여 격리 겹치는 고객 또는 테 넌 트 간에 IP 서브넷의 가능성을 사용 하 여 오버레이 네트워크를 만들려는 NVGRE 또는 VXLAN 캡슐화를 사용 하 여 적용 됩니다.  
  
-   각 가상 네트워크가 호스트에는 고유 라우팅 도메인 ID (RDID)에 있습니다. 이 RDID 가상 네트워크에서 네트워크 컨트롤러 REST 리소스를 식별 하는 리소스 ID를 대략적으로 매핑됩니다. 리소스 URI (Uniform Identifier) 네임 스페이스를 사용 하 여 추가 된 리소스 ID를 사용 하 여 가상 네트워크 REST 리소스 참조  
  
### <a name="VirtualSubnets"></a>가상 서브넷  
  
-   가상 서브넷은 동일한 가상 서브넷 내의 가상 컴퓨터에 대해 계층 3 IP 서브넷 의미 체계를 구현합니다. 가상 서브넷 브로드캐스트 도메인입니다 (VLAN과 유사)을 형성 하 고 격리 NVGRE 테 넌 트 네트워크 ID (TNI) 또는 VXLAN 네트워크 식별자 (vni) 또는 필드를 사용 하 여 적용 됩니다.  
  
-   각 가상 서브넷 단일 가상 네트워크 (RDID)에 속하고 고유 가상 서브넷 ID (VSID) TNI 또는 VNI 키를 사용 하 여 캡슐화 된 패킷 헤더의 할당 됩니다. Vsid가 데이터 센터 내에서 고유 해야 하며 4096 ~ 2 범위에 ^24-2입니다.  
  
클라우드로 가상 네트워크 및 라우팅 도메인의 핵심 이점은 고객은 자신의 네트워크 토폴로지 (예를 들어 IP 서브넷)를 가져올 수 있도록 합니다. 그림 2에서는 Contoso Corp에 별도의 두 네트워크 파란색 연구개발부 넷과 파란색 영업부 넷이 있는 예를 보여 줍니다. 이러한 네트워크는 서로 다른 라우팅 도메인 ID를 가지기 때문에 서로 상호 작용할 수 없습니다. 즉, Contoso R&D Net은 Contoso Corp에서 Contoso Sales Net과 함께 소유하고 있는 네트워크이지만 Contoso Sales Net으로부터 격리되어 있습니다. Contoso R&D Net에는 세 개의 가상 서브넷이 포함됩니다. RDID와 VSID는 둘 다 데이터 센터 내에서 고유합니다.  
  
![고객 네트워크 및 가상 서브넷](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  
  
그림 2: 고객 네트워크 및 가상 서브넷  
  
**계층 2 전달**  
  
그림 2에서 VSID 5001에서 가상 컴퓨터 패킷이 vsid가 5001 Hyper-v 스위치를 통해에 포함 되어 있는 가상 컴퓨터에 전달 된 있을 수 있습니다. Hyper-v 스위치에 특정 VPort VSID 5001에서 가상 컴퓨터에서 들어오는 패킷이 전송 됩니다. 수신 규칙 (예: 캡슐화) 및 매핑 (예: 캡슐화 헤더)는 이러한 패킷을 Hyper-v 스위치에 의해 적용 됩니다. 패킷을 전달 됩니다 하거나 Hyper-v 스위치에 다른 VPort (대상 가상 컴퓨터는 동일한 호스트에 연결 됨) 하는 경우 또는 다른 호스트 (대상 가상 머신에 있는 경우 다른 호스트에)에서 다른 Hyper-v 스위치에 있습니다.  
  
**3 개의 라우팅 계층**  
  
마찬가지로, VSID 5001에서 가상 컴퓨터 패킷이 vsid가 5002 또는 5003 가상 컴퓨터에 각 Hyper-v 호스트의 VSwitch에 존재 하는 HNV 분산된 라우터에 의해 라우트된 있을 수 있습니다. Hyper-v에 패킷을 전달 시 전환, HNV는 들어오는 패킷의 vsid가 대상 가상 머신의 VSID로 업데이트 합니다. 이러한 상황은 두 VSID가 동일한 RDID에 있는 경우에만 발생합니다.  따라서 rdid1의 가상 네트워크 어댑터는 게이트웨이 통과 하지 않고 rdid2의 가상 네트워크 어댑터에 패킷을 보낼 수 없습니다.  
  
> [!NOTE]  
> 패킷 흐름 설명 위의 용어 "가상 머신" 실제로 의미 가상 머신에서 가상 네트워크 어댑터입니다. 일반적인 경우는 가상 컴퓨터에 가상 네트워크 어댑터가 하나뿐인 경우입니다. 이 경우 단어 "가상 머신" 및 "가상 네트워크 어댑터" 동일 개념적 의미할 수 있습니다.  
  
각 가상 서브넷은 VLAN과 유사한 계층 3 IP 서브넷 및 L2(계층 2) 브로드캐스트 도메인 경계를 정의합니다. 가상 컴퓨터에는 패킷을 브로드캐스트하여, HNV를 사용 하 여 유니캐스트 복제 (UR) 원래 패킷의 복사본을 만들고 동일한 VSID에 있는 각 VM의 주소로 대상 IP 및 MAC를 대체 합니다.  
  
> [!NOTE]  
> Windows Server 2016 출시 유니캐스트 복제를 사용 하 여 브로드캐스트 및 서브넷 멀티 캐스트에 구현 됩니다. 서브넷 간 멀티 캐스트 라우팅과 IGMP 지원 되지 않습니다.  
  
브로드캐스트 도메인인 것 외에 VSID는 격리를 제공합니다. HNV에서 가상 네트워크 어댑터를 포트 (virtualNetworkInterface REST 리소스)에 직접 또는의 일부인 가상 서브넷 (VSID)에 적용할 ACL 규칙을 갖게 되는 Hyper-v 스위치 포트에 연결 됩니다.  
  
Hyper-v 스위치 포트에 적용 하는 ACL 규칙이 있어야 합니다. 두이 일 수를 모두 거부 하거나 특정 유형의 일치 하는 5 개 튜플 (원본 IP, 대상 IP, 원본 포트, 대상 포트, 프로토콜) 트래픽 허용 하도록 더 구체적으로 수 없습니다.  
  
> [!NOTE]  
> Hyper-v 스위치 확장의 새 네트워킹 SDN (소프트웨어) 스택을 HNVv2를 사용 하 여 작동 하지 않습니다. HNVv2 다른 타사 스위치 확장을 사용 하 여 함께에서 사용할 수 없는 Azure 가상 필터링 플랫폼 (VFP) 스위치 확장을 사용 하 여 구현 됩니다.  
  
## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>전환 하 고 Hyper-v 네트워크 가상화의 라우팅  
HNVv2 올바른 계층 2 (L2) 전환 하 고 물리적 스위치와 마찬가지로 작동 하려면 3 (L3) 계층 라우팅 의미 체계를 구현 하거나 라우터 작동 합니다. 가상 컴퓨터에 연결할 때는 HNV 가상 네트워크에 원격 가상 컴퓨터의 CA MAC 주소를 확인 하려면 먼저는 동일한 가상 서브넷 (VSID)에 다른 가상 머신과 연결 하려고 합니다. 원본 가상 컴퓨터의 ARP 테이블에서 대상 가상 머신의 IP 주소에 대 한 ARP 항목이 있으면이 항목에서 MAC 주소가 사용 됩니다. 항목이 없으면 원본 가상 컴퓨터는 반환 될 대상 가상 머신의 IP 주소에 해당 하는 MAC 주소에 대 한 요청을 사용 하 여 ARP 브로드캐스트 보냅니다. Hyper-v 스위치는이 요청을 가로채 고 호스트 에이전트에 보냅니다. 요청 된 대상 가상 머신의 IP 주소에 대 한 해당 MAC 주소에 대 한 로컬 데이터베이스에서 호스트 에이전트를 살펴보겠습니다.  
  
> [!NOTE]  
> OVSDB 서버 역할을 호스트 에이전트를 CA-PA 매핑은, MAC 테이블 및 등을 저장 하는 변형의 VTEP 스키마를 사용 합니다.  
  
MAC 주소를 사용 가능한 경우 호스트 에이전트가 ARP 응답을 삽입 하 고 가상 컴퓨터에이 다시 보냅니다. 가상 컴퓨터의 네트워킹 스택을 필요한 모든 L2 헤더 정보에는 프레임 V 스위치에 해당 Hyper-v 포트에 전송 됩니다. 내부적으로 하이퍼-V 스위치는 가상 네트워크에 할당 하는 N-튜플을 일치 하는 규칙에 대해이 프레임을 테스트 하 고 이러한 규칙을 기반으로 하는 프레임을 사용 하 여 특정 변형을 적용할. 가장 중요 하 게 캡슐화 변환 집합을 네트워크 컨트롤러에 정의 된 정책에 따라 NVGRE 또는 VXLAN를 사용 하 여 캡슐화 헤더를 생성 하려면 적용 됩니다. 호스트 에이전트에서 프로그래밍 하는 정책에 따라 CA-PA 매핑이 Hyper-v 호스트의 IP 주소를 확인 하려면 대상 가상 머신에 상주 합니다. Hyper-v 스위치를 통해 올바른 라우팅 규칙 및 원격 PA 주소에 도달 하도록 VLAN 태그 외부 패킷에 적용 됩니다.  
  
HNV 가상 네트워크에 연결 된 가상 컴퓨터를 다른 가상 서브넷 (VSID)에 있는 가상 컴퓨터를 사용 하 여 연결을 만들려면 하려는 경우에 패킷을 적절 하 게 라우팅할 수 해야 합니다. HNV 가정 별 토폴로지를 모든 IP 접두사 (의미 하나의 기본 경로/게이트웨이)에 연결할 다음 홉으로 사용 하는 CA 공간에서 IP 주소가 하나만 있는 합니다. 현재는 단일 기본 경로 제한이 적용 및 기본이 아닌 경로 지원 되지 않습니다.  
  
### <a name="routing-between-virtual-subnets"></a>가상 서브넷 간의 라우팅  
실제 네트워크에 IP 서브넷에는 컴퓨터 (가상 및 실제) 서로 직접 통신할 수 있는 계층 2 (L2) 도메인입니다. L2 도메인은 브로드캐스트 도메인 여기서 모든 인터페이스에 브로드캐스트하는 ARP 요청을 통해 ARP 항목 (IP:MAC 주소 맵)를 학습 하 고 ARP 응답 호스트 요청 다시 전송 됩니다. 컴퓨터 정보를 사용 하 MAC ARP 응답에서 배운 완전히 이더넷 헤더를 포함 하 여 L2 프레임을 생성 합니다. 그러나 IP 주소를 다른 L3 서브넷에 있는 경우 ARP 요청이 L3 경계를 교차 하지 않으며 합니다. 대신, 원본 서브넷에서 IP 주소를 사용 하 여 L3 라우터 인터페이스 (다음 홉 또는 기본 게이트웨이)는 자체 MAC 주소를 사용 하 여 이러한 ARP 요청에 응답 해야 합니다.  
  
표준 Windows 네트워킹에서 관리자는 고정 경로 만들 수 있으며 네트워크 인터페이스에 할당. 또한 "기본 게이트웨이"는 일반적으로 기본 경로 (0.0.0.0/0)에 대 한 패킷을 보내는 인터페이스에서 다음 홉 IP 주소를 구성 합니다. 패킷이 특정 경로가 없는 경우이 기본 게이트웨이로 전송 됩니다. 이는 일반적으로 실제 네트워크에 사용되는 라우터입니다.  HNV에서 가상 네트워크에 대 한 분산된 라우터를 만들려면 모든 VSID 인터페이스 있고 모든 호스트의 일부인 기본 제공 라우터를 사용 합니다.  
  
HNV 별 토폴로지를 가정 하므로 HNV 분산된 라우터는 동일한 vsid가 네트워크의 일부인 가상 서브넷 간에 이동 되는 모든 트래픽에 대 한 단일 기본 게이트웨이로 작동 합니다. 주소는 VSID의 가장 낮은 IP 주소를 기본 게이트웨이 기본값으로 사용 하 고 HNV 분산 라우터에 할당 됩니다. 이 분산된 라우터를 각 호스트 직접 트래픽을 라우팅할 수 있습니다는 적절 한 호스트에서 중개 없이 적절 하 게 라우팅할 수 VSID 네트워크 내부의 모든 트래픽에 대해 매우 효율적인 방법을 허용 합니다.  이는 동일한 VM 네트워크에 있지만 가상 서브넷이 서로 다른 두 개의 가상 컴퓨터가 동일한 실제 호스트에 있는 경우에 특히 유용합니다.  이 섹션의 뒷부분에 설명되어 있는 것처럼, 패킷이 실제 호스트에서 나갈 필요가 없습니다.  
  
### <a name="routing-between-pa-subnets"></a>PA 서브넷 간 라우팅  
PA IP 주소가 하나에 대 한 각 가상 서브넷 (VSID)으로 할당 되는 HNVv1 달리 HNVv2 이제 Switch-Embedded 팀 (SET) NIC 팀 구성원 당 하나의 PA IP 주소를 사용 합니다. 기본 배포 두 NIC 팀을 가정 하 고 호스트 마다 두 개의 PA IP 주소를 할당 합니다. 단일 호스트에 동일한 VLAN에 동일한 PA (공급자) 논리 서브넷에서 할당 된 PA Ip에 있습니다. 두 명의 테 넌 트 Vm에 동일한 가상 서브넷은 두 개의 다른 공급자 논리 서브넷에 연결 된 두 명의 서로 다른 호스트에 실제로 있을 수 있습니다. HNV는 캡슐화 된 패킷 CA-PA 매핑을 기준에 대 한 외부 IP 헤더를 생성 합니다. 그러나 기본 PA 게이트웨이에 대 한 ARP 호스트 TCP/IP 스택을 사용 하 고 외부 이더넷 헤더 ARP 응답에 따라 빌드합니다. 일반적으로이 ARP 응답은 SVI 인터페이스에서 물리적 스위치 또는 라우터 L3 경우 호스트에 연결 됩니다. HNV 공급자 논리 서브넷 간에 캡슐화 된 패킷을 라우팅에 대 한 L3 라우터 따라서 의존 / Vlan입니다.  
  
### <a name="routing-outside-a-virtual-network"></a>가상 네트워크 외부 라우팅  
대부분의 고객 배포에는 HNV 환경에서 HNV 환경에 속하지 않는 리소스로의 통신이 필요합니다. 두 환경 간의 통신을 허용하기 위해서는 네트워크 가상화 게이트웨이가 필요합니다. HNV 게이트웨이가 필요할 인프라 사설 클라우드 및 하이브리드 클라우드를 포함 합니다. 기본적으로, HNV 게이트웨이 여러 사이트 및/또는 IPSec VPN 또는 GRE 터널을 사용 하는 클라우드 (사설 또는 공용) 간 또는 내부 및 외부 (물리적) 네트워크 (NAT 포함) 간에 계층 3 라우팅을 필요 합니다.  
  
게이트웨이는 다양한 실제 폼 팩터로 제공될 수 있습니다. TOR (Top) 스위치 역할 VXLAN 게이트웨이 통해는 VIP (가상 IP) 부하 분산 장치를 통해 보급 된 액세스에 다른 기존 네트워크 어플라이언스에 배치 되거나 새 독립 실행형 네트워크 어플라이언스 일 수에 통합 되는 Windows Server 2016에서 빌드할 수 있습니다. .  
  
RAS 게이트웨이 Windows 옵션에 대 한 자세한 내용은 참조 하세요. [RAS 게이트웨이](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)합니다.  
  
## <a name="packet-encapsulation"></a>패킷 캡슐화  
HNV의 각 가상 네트워크 어댑터는 다음의 두 IP 주소와 연관되어 있습니다.  
  
-   **고객 주소** 해당 인트라넷 인프라에 따라 고객에 의해 할당 된 (CA)의 IP 주소입니다. 이 주소는 공용 또는 사설 클라우드로 이동 되었습니다 했습니다 처럼 가상 머신과 네트워크 트래픽을 교환할 수 있습니다. CA는 가상 컴퓨터에 표시되며 고객은 CA에 접근할 수 있습니다.  
  
-   **공급자 주소** 호스팅 공급자에서 할당 한 (PA) IP 주소 또는 데이터 센터 관리자가 해당 실제 네트워크 인프라를 기반 합니다. PA는 네트워크에서 가상 컴퓨터를 호스팅하는 Hyper-V 실행 서버와 교환되는 패킷에 나타납니다. PA는 실제 네트워크에 표시되지만 가상 컴퓨터에는 표시되지 않습니다.  
  
CA는 PA에 의해 구현된 대로 고객의 네트워크 토폴로지(가상화되었으며 실제 기본 실제 네트워크 토폴로지 및 주소에서 분리됨)를 유지 관리합니다. 다음 다이어그램은 네트워크 가상화 결과로 생성된, 가상 컴퓨터 CA와 네트워크 인프라 PA 간의 개념적 관계를 보여 줍니다.  
  
![실제 인프라에서 네트워크 가상화의 개념적 다이어그램](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  
  
그림 6: 실제 인프라에서 네트워크 가상화의 개념적 다이어그램  
  
다이어그램에서 고객의 가상 머신 자체 가상 네트워크 또는 "터널"을 통해 실제 네트워크 인프라를 트래버스하는 CA 공간에서 데이터 패킷을 보냅니다. 위의 예에서 터널에 게 배달할 원본 호스트 왼쪽에서 오른쪽의 대상 호스트로 녹색 포장용 레이블 (PA 주소)를 사용 하 여 Contoso 및 Fabrikam 데이터 패킷 주위 "포 락 선"으로 생각할 수 있습니다. 키가 호스트 "배달 주소"를 확인 하는 방법 (PA), 해당 하는 Contoso 및 Fabrikam CA의 "봉투 (envelope)"를 패킷 주위에 배치 됩니다 방법 대상 호스트가 패킷을 래핑 해제을 Contoso 및 Fabrikam을 전달할 수 있는 방법은 대상 가상 머신을 올바르게 합니다.  
  
이 간단한 비유는 네트워크 가상화의 핵심적인 면을 잘 나타내 줍니다.  
  
-   각 가상 컴퓨터 CA는 실제 호스트 PA에 매핑됩니다. 여러 CA를 동일한 PA에 연결할 수 있습니다.  
  
-   가상 머신 "envelope" PA 원본 및 대상 쌍을 사용 하 여 매핑을 기준으로 배치 되는 CA 공간에서 데이터 패킷을 보냅니다.  
  
-   CA-PA 매핑은 호스트가 서로 다른 고객 가상 컴퓨터에 대한 패킷을 구분할 수 있도록 해야 합니다.  
  
따라서 네트워크를 가상화하는 메커니즘은 가상 컴퓨터에 사용되는 네트워크 주소를 가상화하는 것입니다. 네트워크 컨트롤러는 주소 매핑을 담당 하 고 호스트 에이전트 MS_VTEP 스키마를 사용 하 여 매핑 데이터베이스를 유지 합니다. 다음 섹션에서는 주소 가상화의 실제 메커니즘에 대해 설명합니다.  
  
## <a name="network-virtualization-through-address-virtualization"></a>주소 가상화를 통한 네트워크 가상화  
HNV 구현에는 Virtual eXtensible Local Area Network (VXLAN) 또는 네트워크 가상화 캡슐화 NVGRE (Generic Routing)를 사용 하 여 테 넌 트 네트워크 오버레이 합니다.  VXLAN 기본값입니다.  
  
### <a name="virtual-extensible-local-area-network-vxlan"></a>Virtual eXtensible Local Area Network (VXLAN)  
Virtual eXtensible Local Area Network (VXLAN) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) 프로토콜은 널리 채택 시장에, Cisco, Brocade, Arista, Dell, HP 등와 같은 공급 업체에서 지원 합니다. VXLAN 프로토콜을 UDP 전송 사용합니다. VXLAN IANA에서 할당 UDP 대상 포트 4789 이며 UDP 원본 포트 ECMP 분산에 사용 되는 내부 패킷 정보의 해시를 이어야 합니다. UDP 헤더 후 VXLAN 헤더는 3 비트 필드에 대 한는 VXLAN 네트워크 식별자 (vni) 또는-VSID-예약 된 다른 1 바이트 필드 뒤에 오는 예약된 된 4 바이트 필드를 포함 하는 패킷을에 추가 됩니다. After VXLAN 헤더 (하지 않고 CA 이더넷 프레임 FC) 원래 CA L2 프레임 추가 됩니다.  
  
![VXLAN 패킷 헤더](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  
  
### <a name="generic-routing-encapsulation-nvgre"></a>Generic Routing Encapsulation (NVGRE)  
이 네트워크 가상화 메커니즘은 터널 헤더의 일부로 캡슐화 NVGRE (Generic Routing)을 사용합니다. Nvgre에서 가상 머신의 패킷은 다른 패킷 내에서 캡슐화 됩니다. 이 새 패킷의 헤더에는 그림 7에 표시된 것처럼 GRE 헤더의 키 필드에 저장된 가상 서브넷 ID 외에 적절한 원본 및 대상 PA IP 주소가 포함되어 있습니다.  
  
![NVGRE 캡슐화](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  
  
그림 7: 네트워크 가상화 - NVGRE 캡슐화  
  
가상 서브넷 ID를 지정된 된 패킷에 대 한 고객 가상 컴퓨터를 식별할 수 있습니다, 그리고는 패킷의 PA와 CA의 경우에 겹칠 수 있습니다. 이를 통해 그림 7에 표시된 것처럼 동일한 호스트의 모든 가상 컴퓨터가 단일 PA를 공유할 수 있습니다.  
  
PA 공유는 네트워크 확장성에 큰 영향을 줍니다. 네트워크 인프라에서 알아야 하는 IP 및 MAC 주소 수를 상당히 줄일 수 있습니다. 예를 들어, 모든 최종 호스트에 평균 30대의 가상 컴퓨터가 있는 경우 네트워크 인프라에서 알아야 하는 IP 및 MAC 주소 수는 인수 30으로 줄어듭니다. 또한 패킷에 포함된 가상 서브넷 ID를 통해 쉽게 실제 고객과 패킷 간의 상관 관계를 알 수 있습니다.  
  
Windows Server 2012 R2에 대 한 스키마를 공유 하는 PA 호스트당 VSID 당 하나의 PA는입니다. Windows Server 2016에 대 한 구성표는 NIC 팀 구성원 당 하나의 PA입니다.  
  
Windows Server 2016 이상에서 HNV 완벽 하 게 지원 NVGRE 및 VXLAN 즉시; 업그레이드 하거나 이러한 Nic (네트워크 어댑터), 스위치 또는 라우터와 같은 새 네트워크 하드웨어를 구입할 필요가 없습니다. 통신 중에이 패킷을 사항은 현재의 네트워크 인프라와 호환 되는 PA 공간에서 일반 IP 패킷이 때문입니다.  그러나 활용 성능 작업 오프 로드를 지 원하는 최신 드라이버를 사용 하 여 Nic 지원 합니다.  
  
## <a name="multi-tenant-deployment-example"></a>다중 테넌트 배포 예  
다음 다이어그램은 네트워크 정책에 의해 정의 된 CA-PA 관계를 사용 하 여 클라우드 데이터 센터에 있는 두 고객의 배포를 예제를 보여줍니다.  
  
![다중 테넌트 배포 예](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  
  
그림 8: 다중 테넌트 배포 예  
  
그림 8의 예를 살펴보십시오. 호스팅 공급자의 공유 IaaS 서비스로 이동하기 전:  
  
-   Contoso Corp는 IP 주소 10.1.1.11에서 SQL Server(이름: **SQL**)를 실행하고, IP 주소 10.1.1.12에서 웹 서버(이름: **Web**)를 실행합니다. 이 주소에서는 데이터베이스 트랜잭션에 해당 SQL Server를 사용합니다.  
  
-   Fabrikam Corp는 SQL Server(이름: **SQL** )를 실행하고 IP 주소 10.1.1.11을 할당했으며, IP 주소 10.1.1.12에서 웹 서버(이름: **Web** )를 실행하고 데이터베이스 트랜잭션에 해당 SQL Server를 사용합니다.  
  
호스팅 서비스 공급자가 해당 실제 네트워크 토폴로지와 일치 하도록 네트워크 컨트롤러를 통해 공급자 (PA) 논리 네트워크를 만든 가정 합니다. 네트워크 컨트롤러 호스트에 연결 되어 있는 논리 서브넷의 IP 접두사에서 두 개의 PA IP 주소를 할당 합니다. 또한 네트워크 컨트롤러 IP 주소를 적용할 적합 한 VLAN 태그를 나타냅니다.  
  
해당 가상 네트워크 및 서브넷에서 호스팅 서비스 공급자가 지정 된 공급자 (PA) 논리 네트워크를 지 원하는 네트워크 컨트롤러에서 Contoso Corp와 Fabrikam Corp를 다음 사용 하 여 만듭니다. Contoso Corp와 Fabrikam Corp는 각각 해당 SQL Server 및 웹 서버를 동일한 호스팅 공급자의 공유 IaaS 서비스로 이동하고 동시에 Hyper-V 호스트 1에서 **SQL** 가상 컴퓨터를 실행하고 Hyper-V 호스트 2에서 **Web** (IIS7) 가상 컴퓨터를 실행합니다. 모든 가상 컴퓨터는 원래 인트라넷 IP 주소(해당 CA)를 유지합니다.  
  
두 회사는 아래와 같이 다음 가상 서브넷 ID (VSID) 네트워크 컨트롤러에서 할당 됩니다.  각 Hyper-v 호스트에서 호스트 에이전트 네트워크 컨트롤러에서 할당된 된 PA IP 주소를 수신 하 고 기본이 아닌 네트워크 구획에 두 PA 호스트 Vnic를 만듭니다. 네트워크 인터페이스는 각각 아래와 같이 PA IP 주소를 할당 하는 여기서 이러한 호스트 Vnic에 할당 됩니다.  
  
-   Contoso Corp 가상 컴퓨터의 Pa 및 VSID: **VSID** 는 5001이 고, **SQL PA** 은 192.168.1.10 이며, **웹 PA** 은 192.168.2.20입니다  
  
-   Fabrikam Corp 가상 컴퓨터의 Pa 및 VSID: **VSID** 는 6001이 고, **SQL PA** 은 192.168.1.10 이며, **웹 PA** 은 192.168.2.20입니다  
  
네트워크 컨트롤러 (OVSDB 데이터베이스 테이블)에서 영구 저장소에서 정책을 유지 관리 하는 SDN 호스트 에이전트 (CA-PA 매핑이 포함) 모든 네트워크 정책은 트리거되 합니다.  
  
Hyper-v 호스트 2에서 Contoso Corp Web 가상 머신 (: 10.1.1.12(contoso) 10.1.1.11에서 SQL Server에 TCP 연결을 만들면 다음 상황이 발생 합니다.  
  
-   10.1.1.11의 대상 MAC 주소에 대 한 Arp VM  
  
-   VSwitch VFP 확장이이 패킷 가로채서 SDN 호스트 에이전트에 보냅니다.  
  
-   SDN 호스트 에이전트 10.1.1.11의 MAC 주소에 대해 해당 정책 저장소 검색  
  
-   호스트 에이전트가 VM에 다시 ARP 응답을 삽입 MAC 있으면  
  
-   MAC 없으면 응답이 전송 되 고 ARP 항목 10.1.1.11에 대 한 VM에 연결할 수 없는 표시 됩니다.  
  
-   VM에서 이제 올바른 CA 이더넷 및 IP 헤더를 사용 하 여 TCP 패킷을 생성 하 고 vSwitch 보냅니다.  
  
-   전달 확장에서 vSwitch VFP 패킷을 받은 및 VFP 통합된 흐름 표에 새 흐름 항목을 만들고 원본 vSwitch 포트에 할당 (아래 설명 참조) VFP 계층을 통해이 패킷 처리  
  
-   VFP 엔진은 IP 및 이더넷 헤더를 기반으로 각 계층 (예: 가상 네트워크 레이어)에 대 한 규칙 일치 또는 흐름 테이블 조회를 수행 합니다.  
  
-   가상 네트워크 계층에서 일치 규칙 CA-PA 매핑은 공간을 참조 하 고 캡슐화를 수행 합니다.  
  
-   Vsid가 함께 VNet 계층 (VXLAN 또는 NVGRE) 캡슐화 형식 지정 됩니다.  
  
-   VXLAN 캡슐화의 경우 외부 UDP 헤더는 VSID 5001 VXLAN 헤더에서를 사용 하 여 생성 됩니다.  
    외부 IP 헤더를 Hyper-v 호스트 2 (192.168.2.20) 및 Hyper-v 호스트 1 (192.168.1.10)에서 SDN 호스트 에이전트의 정책 저장소에 따라 각각에 할당 된 원본 및 대상 PA 주소를 사용 하 여 생성 됩니다.  
  
-   이 패킷 다음 VFP에서 PA 라우팅 계층으로 이동합니다.  
  
-   VFP에서 라우팅 PA 레이어가 PA 공간 트래픽 및 VLAN ID에 사용 되는 네트워크 구획을 참조 하 고 TCP/IP 스택을 호스트를 사용 하 여 Hyper-v 호스트 1 PA 패킷을 올바르게 전달 합니다.  
  
-   캡슐화 된 패킷을 수신 하면 Hyper-v 호스트 1 PA 네트워크 구획에서 패킷의 받고 vSwitch를 전달 합니다.  
  
-   VFP는 VFP 계층을 통해 패킷을 처리 하 고 및 VFP 통합된 흐름 테이블에 새 흐름-항목을 만듭니다.  
  
-   VFP 가상 네트워크 계층에서 ingres 규칙과 일치 엔진과 외부 캡슐화 된 패킷의 이더넷, IP 및 VXLAN 헤더를 제거 합니다.  
  
-   VFP 엔진에 연결 되는 대상 VM의 vSwitch 포트에 패킷을 전달 합니다.  
  
Fabrikam Corp **Web** 및 **SQL** 가상 컴퓨터 간의 트랙픽에 대해 비슷한 프로세스에서는 Fabrikam Corp의 HNV 정책 설정을 사용합니다. 결과적으로, Fabrikam Corp와 Contoso Corp 가상 컴퓨터는 HNV를 통해 원래의 인트라넷에서와 같이 상호 작용합니다. Fabrikam Corp 가상 컴퓨터와 Contoso Corp 가상 컴퓨터는 동일한 IP 주소를 사용하고 있더라도 서로 상호 작용할 수 없습니다.  
  
별도 주소 (Ca 및 Pa), Hyper-v 호스트의 정책 설정 및 CA와 인바운드 및 아웃 바운드 가상 머신 트래픽에 대 한 PA 간의 주소 변환에서는 이러한 집합이 NVGRE 키나 VLXAN VNID 중 하나를 사용 하 여 서버를 분리 합니다. 또한 가상화 매핑과 변환에서는 실제 네트워크 인프라에서 가상 네트워크 아키텍처를 분리합니다. Contoso **SQL** 및 **Web** 과 Fabrikam **SQL** 및 **Web** 이 고유 CA IP 서브넷(10.1.1/24)에 상주하더라도 실제 배포는 각각 서로 다른 PA 서브넷의 두 호스트 192.168.1/24 및 192.168.2/24에서 수행됩니다. 여기에 함축된 의미는 HNV를 통해 서브넷 간 가상 컴퓨터 프로비저닝 및 실시간 마이그레이션이 가능하다는 것입니다.  
  
## <a name="hyper-v-network-virtualization-architecture"></a>Hyper-V 네트워크 가상화 아키텍처  
Windows Server 2016 HNVv2 Azure 가상 필터링 플랫폼 (VFP) Hyper-v 스위치 내의 NDIS 필터링 확장인를 사용 하 여 구현 됩니다. VFP의 핵심 개념을 사용 하면 네트워크 정책 프로그래밍에 대 한 SDN 호스트 에이전트에 노출 되는 내부 API 사용 하 여 일치 작업 흐름 엔진의는입니다. SDN 호스트 에이전트 자체 OVSDB 및 WCF SouthBound 통신 채널을 통해 네트워크 컨트롤러에서 네트워크 정책을 받습니다. 뿐만 아니라는 가상 네트워크 정책 (예: CA-PA 매핑이) VFP Acl, QoS, 등과 같은 추가 정책 사용 하 여 프로그래밍 합니다.  
  
고 vSwitch VFP 전달 확장에 대 한 개체 계층 구조는 다음과 같습니다.  
  
-   vSwitch  
  
    -   외부 NIC 관리  
  
    -   NIC 하드웨어 오프 로드  
  
    -   전역 전달 규칙  
  
    -   포트  
  
        -   십자선 고정에 대 한 계층을 전달 하는 송신  
  
        -   매핑 및 NAT 풀에 대 한 공간을 나열합니다.  
  
        -   통합된 흐름 테이블  
  
        -   VFP 계층  
  
            -   흐름 테이블  
  
            -   그룹  
  
            -   규칙  
  
                -   규칙에는 공간 참조 수 있습니다.  
  
VFP, 계층 정책 유형 (예를 들어, 가상 네트워크) 마다 생성 되 고는 제네릭 집합 규칙/흐름 테이블입니다. 특정 규칙은 이러한 기능을 구현 하는 계층에 할당 될 때까지 모든 내장 기능 되지 않은 합니다. 각 계층에는 우선 순위가 할당 됩니다 및 레이어는 우선 순위를 오름차순으로 포트에 할당 됩니다. 규칙은 방향 및 IP 주소 패밀리에 주로 기반 그룹으로 구성 됩니다. 그룹을 우선 순위가 할당 된 최대 하나의 규칙 그룹에서 지정된 된 흐름이 매칭 하며  
  
VSwitch VFP 확장을 사용 하 여에 대 한 전달 논리는 다음과 같습니다.  
  
-   수신 처리 (수신 포트에 들어오는 패킷의 관점에서)  
  
-   전달  
  
-   송신 처리 (송신 포트를 유지 하는 패킷의 관점에서)  
  
VFP 외부 MAC VLAN 기반 전달 뿐만 아니라 NVGRE 및 VXLAN 캡슐화 형식에 대 한 내부 MAC 전달을 지원합니다.  
  
VFP 확장에는 패킷 순회에 대 한 빠른 경로 느린 경로 있습니다. 흐름에서 첫 번째 패킷을 각 계층의 모든 규칙 그룹을 이동 하 고 규칙을 수행 해야 조회 작업은 비용이 많이 드는 작업입니다. 그러나 흐름 (일치 규칙에 따라) 작업의 목록 포함 한 통합된 흐름 테이블에 등록 되 면 모든 후속 패킷이 처리할 통합된 흐름 테이블 항목을 기반으로 합니다.  
  
HNV 정책 호스트 에이전트에서 프로그래밍 됩니다. 각 가상 컴퓨터 네트워크 어댑터 IPv4 주소를 사용 하 여 구성 됩니다. 이는 가상 컴퓨터가 서로 통신하는 데 사용되는 CA이며, 가상 컴퓨터에서 IP 패킷으로 전달됩니다. HNV PA 프레임 호스트 에이전트의 데이터베이스에 저장 하는 네트워크 가상화 정책을 기반으로 CA 프레임을 캡슐화 합니다.  
  
![HNV 아키텍처](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  
  
그림 9: HNV 아키텍처  
  
## <a name="summary"></a>요약  
클라우드 기반 데이터 센터는 향상된 확장성 및 보다 우수한 리소스 사용률과 같은 여러 이점을 제공할 수 있습니다. 이러한 잠재적 이점을 실현하려면 기본적으로 동적 환경에서 다중 테넌트 확장성 문제를 해결하는 기술이 필요합니다. HNV는 실제 네트워크 토폴로지에 대해 가상 네트워크 토폴로지를 분리하여 이러한 문제를 해결하고 데이터 센터의 운영 효율성을 개선하도록 설계되었습니다. 기존 표준 빌드 HNV 현재의 데이터 센터에서 실행 및 기존 VXLAN 인프라를 사용 하 여 작동 합니다. HNV 통해 고객은 이제 데이터 센터를 사설 클라우드로 통합 하거나 하이브리드 클라우드를 사용 하 여 호스팅 서버 공급자의 환경에 자체 데이터 센터를 원활 하 게 확장할 수 있습니다.  
  
## <a name="BKMK_LINKS"></a>참고 항목  
에 대해 알아보려면 다음 링크를 참조 HNVv2 대 한 자세한 정보:  
  
|콘텐츠 형식|참조|  
|----------------|--------------|  
|**커뮤니티 리소스**|-   [사설 클라우드 아키텍처 블로그](https://blogs.technet.com/b/privatecloud)<br />-질문 하기: [cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)|  
|**RFC**|-   [NVGRE Draft RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN - RFC 7348](https://www.rfc-editor.org/info/rfc7348)|  
|**관련된 기술**|-Windows Server 2012 R2의 Hyper-v 네트워크 가상화 기술 정보에 대 한 참조 [Hyper-v 네트워크 가상화 기술 세부 정보](https://technet.microsoft.com/library/jj134174.aspx)<br />-   [네트워크 컨트롤러](../../../sdn/technologies/network-controller/Network-Controller.md)|  
  


